class Point{constructor(a,b){this.x=a;this.y=b}}class Rectangle{constructor(a,b,c,d){this.x=a;this.y=b;this.Width=c;this.Height=d}}class Unistroke{constructor(a,b){this.Name=a;this.Points=Resample(b,NumPoints);a=IndicativeAngle(this.Points);this.Points=RotateBy(this.Points,-a);this.Points=ScaleTo(this.Points,SquareSize);this.Points=TranslateTo(this.Points,Origin);this.Vector=Vectorize(this.Points)}}class Result{constructor(a,b,c){this.Name=a;this.Score=b;this.Time=c}}
const NumPoints=64,SquareSize=250,Origin=new Point(0,0),Diagonal=Math.sqrt(SquareSize*SquareSize+SquareSize*SquareSize),HalfDiagonal=.5*Diagonal,AngleRange=Deg2Rad(45),AnglePrecision=Deg2Rad(2),Phi=.5*(-1+Math.sqrt(5));
class DollarRecognizer{constructor(){this.Unistrokes=[];this.Unistrokes.push(new Unistroke("triangle",[new Point(576,451),new Point(582,434),new Point(587,418),new Point(593,399),new Point(599,380),new Point(606,361),new Point(612,346),new Point(617,331),new Point(627,345),new Point(635,359),new Point(649,383),new Point(665,413),new Point(679,442),new Point(689,465),new Point(700,494),new Point(657,489),new Point(616,487),new Point(573,485),new Point(538,485),new Point(519,485),new Point(500,486)]));
this.Unistrokes.push(new Unistroke("triangle",[new Point(576,451),new Point(582,434),new Point(587,418),new Point(593,399),new Point(599,380),new Point(606,361),new Point(612,346),new Point(617,331),new Point(627,345),new Point(635,359),new Point(649,383),new Point(665,413),new Point(679,442),new Point(689,465),new Point(700,494),new Point(657,489),new Point(616,487),new Point(573,485),new Point(538,485),new Point(519,485),new Point(500,486)].reverse()));this.Unistrokes.push(new Unistroke("triangle",
[new Point(549,500),new Point(554,486),new Point(560,470),new Point(569,450),new Point(583,421),new Point(597,389),new Point(609,360),new Point(617,336),new Point(624,318),new Point(631,300),new Point(638,319),new Point(648,341),new Point(660,367),new Point(675,396),new Point(685,418),new Point(694,443),new Point(677,439),new Point(660,434),new Point(641,431),new Point(620,428),new Point(590,426)]));this.Unistrokes.push(new Unistroke("triangle",[new Point(549,500),new Point(554,486),new Point(560,
470),new Point(569,450),new Point(583,421),new Point(597,389),new Point(609,360),new Point(617,336),new Point(624,318),new Point(631,300),new Point(638,319),new Point(648,341),new Point(660,367),new Point(675,396),new Point(685,418),new Point(694,443),new Point(677,439),new Point(660,434),new Point(641,431),new Point(620,428),new Point(590,426)].reverse()));this.Unistrokes.push(new Unistroke("triangle",[new Point(137,139),new Point(135,141),new Point(133,144),new Point(132,146),new Point(130,149),
new Point(128,151),new Point(126,155),new Point(123,160),new Point(120,166),new Point(116,171),new Point(112,177),new Point(107,183),new Point(102,188),new Point(100,191),new Point(95,195),new Point(90,199),new Point(86,203),new Point(82,206),new Point(80,209),new Point(75,213),new Point(73,213),new Point(70,216),new Point(67,219),new Point(64,221),new Point(61,223),new Point(60,225),new Point(62,226),new Point(65,225),new Point(67,226),new Point(74,226),new Point(77,227),new Point(85,229),new Point(91,
230),new Point(99,231),new Point(108,232),new Point(116,233),new Point(125,233),new Point(134,234),new Point(145,233),new Point(153,232),new Point(160,233),new Point(170,234),new Point(177,235),new Point(179,236),new Point(186,237),new Point(193,238),new Point(198,239),new Point(200,237),new Point(202,239),new Point(204,238),new Point(206,234),new Point(205,230),new Point(202,222),new Point(197,216),new Point(192,207),new Point(186,198),new Point(179,189),new Point(174,183),new Point(170,178),new Point(164,
171),new Point(161,168),new Point(154,160),new Point(148,155),new Point(143,150),new Point(138,148),new Point(136,148)]));this.Unistrokes.push(new Unistroke("triangle",[new Point(137,139),new Point(135,141),new Point(133,144),new Point(132,146),new Point(130,149),new Point(128,151),new Point(126,155),new Point(123,160),new Point(120,166),new Point(116,171),new Point(112,177),new Point(107,183),new Point(102,188),new Point(100,191),new Point(95,195),new Point(90,199),new Point(86,203),new Point(82,
206),new Point(80,209),new Point(75,213),new Point(73,213),new Point(70,216),new Point(67,219),new Point(64,221),new Point(61,223),new Point(60,225),new Point(62,226),new Point(65,225),new Point(67,226),new Point(74,226),new Point(77,227),new Point(85,229),new Point(91,230),new Point(99,231),new Point(108,232),new Point(116,233),new Point(125,233),new Point(134,234),new Point(145,233),new Point(153,232),new Point(160,233),new Point(170,234),new Point(177,235),new Point(179,236),new Point(186,237),
new Point(193,238),new Point(198,239),new Point(200,237),new Point(202,239),new Point(204,238),new Point(206,234),new Point(205,230),new Point(202,222),new Point(197,216),new Point(192,207),new Point(186,198),new Point(179,189),new Point(174,183),new Point(170,178),new Point(164,171),new Point(161,168),new Point(154,160),new Point(148,155),new Point(143,150),new Point(138,148),new Point(136,148)].reverse()));this.Unistrokes.push(new Unistroke("rectangle",[new Point(78,149),new Point(78,153),new Point(78,
157),new Point(78,160),new Point(79,162),new Point(79,164),new Point(79,167),new Point(79,169),new Point(79,173),new Point(79,178),new Point(79,183),new Point(80,189),new Point(80,193),new Point(80,198),new Point(80,202),new Point(81,208),new Point(81,210),new Point(81,216),new Point(82,222),new Point(82,224),new Point(82,227),new Point(83,229),new Point(83,231),new Point(85,230),new Point(88,232),new Point(90,233),new Point(92,232),new Point(94,233),new Point(99,232),new Point(102,233),new Point(106,
233),new Point(109,234),new Point(117,235),new Point(123,236),new Point(126,236),new Point(135,237),new Point(142,238),new Point(145,238),new Point(152,238),new Point(154,239),new Point(165,238),new Point(174,237),new Point(179,236),new Point(186,235),new Point(191,235),new Point(195,233),new Point(197,233),new Point(200,233),new Point(201,235),new Point(201,233),new Point(199,231),new Point(198,226),new Point(198,220),new Point(196,207),new Point(195,195),new Point(195,181),new Point(195,173),new Point(195,
163),new Point(194,155),new Point(192,145),new Point(192,143),new Point(192,138),new Point(191,135),new Point(191,133),new Point(191,130),new Point(190,128),new Point(188,129),new Point(186,129),new Point(181,132),new Point(173,131),new Point(162,131),new Point(151,132),new Point(149,132),new Point(138,132),new Point(136,132),new Point(122,131),new Point(120,131),new Point(109,130),new Point(107,130),new Point(90,132),new Point(81,133),new Point(76,133)]));this.Unistrokes.push(new Unistroke("circle",
[new Point(127,141),new Point(124,140),new Point(120,139),new Point(118,139),new Point(116,139),new Point(111,140),new Point(109,141),new Point(104,144),new Point(100,147),new Point(96,152),new Point(93,157),new Point(90,163),new Point(87,169),new Point(85,175),new Point(83,181),new Point(82,190),new Point(82,195),new Point(83,200),new Point(84,205),new Point(88,213),new Point(91,216),new Point(96,219),new Point(103,222),new Point(108,224),new Point(111,224),new Point(120,224),new Point(133,223),
new Point(142,222),new Point(152,218),new Point(160,214),new Point(167,210),new Point(173,204),new Point(178,198),new Point(179,196),new Point(182,188),new Point(182,177),new Point(178,167),new Point(170,150),new Point(163,138),new Point(152,130),new Point(143,129),new Point(140,131),new Point(129,136),new Point(126,139)]));this.Unistrokes.push(new Unistroke("circle",[new Point(127,141),new Point(124,140),new Point(120,139),new Point(118,139),new Point(116,139),new Point(111,140),new Point(109,141),
new Point(104,144),new Point(100,147),new Point(96,152),new Point(93,157),new Point(90,163),new Point(87,169),new Point(85,175),new Point(83,181),new Point(82,190),new Point(82,195),new Point(83,200),new Point(84,205),new Point(88,213),new Point(91,216),new Point(96,219),new Point(103,222),new Point(108,224),new Point(111,224),new Point(120,224),new Point(133,223),new Point(142,222),new Point(152,218),new Point(160,214),new Point(167,210),new Point(173,204),new Point(178,198),new Point(179,196),new Point(182,
188),new Point(182,177),new Point(178,167),new Point(170,150),new Point(163,138),new Point(152,130),new Point(143,129),new Point(140,131),new Point(129,136),new Point(126,139)].reverse()));this.Unistrokes.push(new Unistroke("circle",[new Point(718,309),new Point(701,306),new Point(682,306),new Point(654,308),new Point(623,318),new Point(592,336),new Point(570,360),new Point(557,392),new Point(554,426),new Point(561,462),new Point(577,492),new Point(599,511),new Point(628,520),new Point(659,525),new Point(684,
527),new Point(704,520),new Point(718,501),new Point(723,472),new Point(719,439),new Point(699,403),new Point(668,374),new Point(634,355),new Point(601,343),new Point(569,338),new Point(544,339),new Point(529,344),new Point(529,344)]));this.Unistrokes.push(new Unistroke("check",[new Point(91,185),new Point(93,185),new Point(95,185),new Point(97,185),new Point(100,188),new Point(102,189),new Point(104,190),new Point(106,193),new Point(108,195),new Point(110,198),new Point(112,201),new Point(114,204),
new Point(115,207),new Point(117,210),new Point(118,212),new Point(120,214),new Point(121,217),new Point(122,219),new Point(123,222),new Point(124,224),new Point(126,226),new Point(127,229),new Point(129,231),new Point(130,233),new Point(129,231),new Point(129,228),new Point(129,226),new Point(129,224),new Point(129,221),new Point(129,218),new Point(129,212),new Point(129,208),new Point(130,198),new Point(132,189),new Point(134,182),new Point(137,173),new Point(143,164),new Point(147,157),new Point(151,
151),new Point(155,144),new Point(161,137),new Point(165,131),new Point(171,122),new Point(174,118),new Point(176,114),new Point(177,112),new Point(177,114),new Point(175,116),new Point(173,118)]));this.Unistrokes.push(new Unistroke("caret",[new Point(79,245),new Point(79,242),new Point(79,239),new Point(80,237),new Point(80,234),new Point(81,232),new Point(82,230),new Point(84,224),new Point(86,220),new Point(86,218),new Point(87,216),new Point(88,213),new Point(90,207),new Point(91,202),new Point(92,
200),new Point(93,194),new Point(94,192),new Point(96,189),new Point(97,186),new Point(100,179),new Point(102,173),new Point(105,165),new Point(107,160),new Point(109,158),new Point(112,151),new Point(115,144),new Point(117,139),new Point(119,136),new Point(119,134),new Point(120,132),new Point(121,129),new Point(122,127),new Point(124,125),new Point(126,124),new Point(129,125),new Point(131,127),new Point(132,130),new Point(136,139),new Point(141,154),new Point(145,166),new Point(151,182),new Point(156,
193),new Point(157,196),new Point(161,209),new Point(162,211),new Point(167,223),new Point(169,229),new Point(170,231),new Point(173,237),new Point(176,242),new Point(177,244),new Point(179,250),new Point(181,255),new Point(182,257)]));this.Unistrokes.push(new Unistroke("zig-zag",[new Point(307,216),new Point(333,186),new Point(356,215),new Point(375,186),new Point(399,216),new Point(418,186)]));this.Unistrokes.push(new Unistroke("arrow",[new Point(68,222),new Point(70,220),new Point(73,218),new Point(75,
217),new Point(77,215),new Point(80,213),new Point(82,212),new Point(84,210),new Point(87,209),new Point(89,208),new Point(92,206),new Point(95,204),new Point(101,201),new Point(106,198),new Point(112,194),new Point(118,191),new Point(124,187),new Point(127,186),new Point(132,183),new Point(138,181),new Point(141,180),new Point(146,178),new Point(154,173),new Point(159,171),new Point(161,170),new Point(166,167),new Point(168,167),new Point(171,166),new Point(174,164),new Point(177,162),new Point(180,
160),new Point(182,158),new Point(183,156),new Point(181,154),new Point(178,153),new Point(171,153),new Point(164,153),new Point(160,153),new Point(150,154),new Point(147,155),new Point(141,157),new Point(137,158),new Point(135,158),new Point(137,158),new Point(140,157),new Point(143,156),new Point(151,154),new Point(160,152),new Point(170,149),new Point(179,147),new Point(185,145),new Point(192,144),new Point(196,144),new Point(198,144),new Point(200,144),new Point(201,147),new Point(199,149),new Point(194,
157),new Point(191,160),new Point(186,167),new Point(180,176),new Point(177,179),new Point(171,187),new Point(169,189),new Point(165,194),new Point(164,196)]));this.Unistrokes.push(new Unistroke("left square bracket",[new Point(140,124),new Point(138,123),new Point(135,122),new Point(133,123),new Point(130,123),new Point(128,124),new Point(125,125),new Point(122,124),new Point(120,124),new Point(118,124),new Point(116,125),new Point(113,125),new Point(111,125),new Point(108,124),new Point(106,125),
new Point(104,125),new Point(102,124),new Point(100,123),new Point(98,123),new Point(95,124),new Point(93,123),new Point(90,124),new Point(88,124),new Point(85,125),new Point(83,126),new Point(81,127),new Point(81,129),new Point(82,131),new Point(82,134),new Point(83,138),new Point(84,141),new Point(84,144),new Point(85,148),new Point(85,151),new Point(86,156),new Point(86,160),new Point(86,164),new Point(86,168),new Point(87,171),new Point(87,175),new Point(87,179),new Point(87,182),new Point(87,
186),new Point(88,188),new Point(88,195),new Point(88,198),new Point(88,201),new Point(88,207),new Point(89,211),new Point(89,213),new Point(89,217),new Point(89,222),new Point(88,225),new Point(88,229),new Point(88,231),new Point(88,233),new Point(88,235),new Point(89,237),new Point(89,240),new Point(89,242),new Point(91,241),new Point(94,241),new Point(96,240),new Point(98,239),new Point(105,240),new Point(109,240),new Point(113,239),new Point(116,240),new Point(121,239),new Point(130,240),new Point(136,
237),new Point(139,237),new Point(144,238),new Point(151,237),new Point(157,236),new Point(159,237)]));this.Unistrokes.push(new Unistroke("right square bracket",[new Point(112,138),new Point(112,136),new Point(115,136),new Point(118,137),new Point(120,136),new Point(123,136),new Point(125,136),new Point(128,136),new Point(131,136),new Point(134,135),new Point(137,135),new Point(140,134),new Point(143,133),new Point(145,132),new Point(147,132),new Point(149,132),new Point(152,132),new Point(153,134),
new Point(154,137),new Point(155,141),new Point(156,144),new Point(157,152),new Point(158,161),new Point(160,170),new Point(162,182),new Point(164,192),new Point(166,200),new Point(167,209),new Point(168,214),new Point(168,216),new Point(169,221),new Point(169,223),new Point(169,228),new Point(169,231),new Point(166,233),new Point(164,234),new Point(161,235),new Point(155,236),new Point(147,235),new Point(140,233),new Point(131,233),new Point(124,233),new Point(117,235),new Point(114,238),new Point(112,
238)]));this.Unistrokes.push(new Unistroke("v",[new Point(89,164),new Point(90,162),new Point(92,162),new Point(94,164),new Point(95,166),new Point(96,169),new Point(97,171),new Point(99,175),new Point(101,178),new Point(103,182),new Point(106,189),new Point(108,194),new Point(111,199),new Point(114,204),new Point(117,209),new Point(119,214),new Point(122,218),new Point(124,222),new Point(126,225),new Point(128,228),new Point(130,229),new Point(133,233),new Point(134,236),new Point(136,239),new Point(138,
240),new Point(139,242),new Point(140,244),new Point(142,242),new Point(142,240),new Point(142,237),new Point(143,235),new Point(143,233),new Point(145,229),new Point(146,226),new Point(148,217),new Point(149,208),new Point(149,205),new Point(151,196),new Point(151,193),new Point(153,182),new Point(155,172),new Point(157,165),new Point(159,160),new Point(162,155),new Point(164,150),new Point(165,148),new Point(166,146)]));this.Unistrokes.push(new Unistroke("triangle",[new Point(123,129),new Point(123,
131),new Point(124,133),new Point(125,136),new Point(127,140),new Point(129,142),new Point(133,148),new Point(137,154),new Point(143,158),new Point(145,161),new Point(148,164),new Point(153,170),new Point(158,176),new Point(160,178),new Point(164,183),new Point(168,188),new Point(171,191),new Point(175,196),new Point(178,200),new Point(180,202),new Point(181,205),new Point(184,208),new Point(186,210),new Point(187,213),new Point(188,215),new Point(186,212),new Point(183,211),new Point(177,208),new Point(169,
206),new Point(162,205),new Point(154,207),new Point(145,209),new Point(137,210),new Point(129,214),new Point(122,217),new Point(118,218),new Point(111,221),new Point(109,222),new Point(110,219),new Point(112,217),new Point(118,209),new Point(120,207),new Point(128,196),new Point(135,187),new Point(138,183),new Point(148,167),new Point(157,153),new Point(163,145),new Point(165,142),new Point(172,133),new Point(177,127),new Point(179,127),new Point(180,125)]));this.Unistrokes.push(new Unistroke("left curly brace",
[new Point(150,116),new Point(147,117),new Point(145,116),new Point(142,116),new Point(139,117),new Point(136,117),new Point(133,118),new Point(129,121),new Point(126,122),new Point(123,123),new Point(120,125),new Point(118,127),new Point(115,128),new Point(113,129),new Point(112,131),new Point(113,134),new Point(115,134),new Point(117,135),new Point(120,135),new Point(123,137),new Point(126,138),new Point(129,140),new Point(135,143),new Point(137,144),new Point(139,147),new Point(141,149),new Point(140,
152),new Point(139,155),new Point(134,159),new Point(131,161),new Point(124,166),new Point(121,166),new Point(117,166),new Point(114,167),new Point(112,166),new Point(114,164),new Point(116,163),new Point(118,163),new Point(120,162),new Point(122,163),new Point(125,164),new Point(127,165),new Point(129,166),new Point(130,168),new Point(129,171),new Point(127,175),new Point(125,179),new Point(123,184),new Point(121,190),new Point(120,194),new Point(119,199),new Point(120,202),new Point(123,207),new Point(127,
211),new Point(133,215),new Point(142,219),new Point(148,220),new Point(151,221)]));this.Unistrokes.push(new Unistroke("right curly brace",[new Point(117,132),new Point(115,132),new Point(115,129),new Point(117,129),new Point(119,128),new Point(122,127),new Point(125,127),new Point(127,127),new Point(130,127),new Point(133,129),new Point(136,129),new Point(138,130),new Point(140,131),new Point(143,134),new Point(144,136),new Point(145,139),new Point(145,142),new Point(145,145),new Point(145,147),
new Point(145,149),new Point(144,152),new Point(142,157),new Point(141,160),new Point(139,163),new Point(137,166),new Point(135,167),new Point(133,169),new Point(131,172),new Point(128,173),new Point(126,176),new Point(125,178),new Point(125,180),new Point(125,182),new Point(126,184),new Point(128,187),new Point(130,187),new Point(132,188),new Point(135,189),new Point(140,189),new Point(145,189),new Point(150,187),new Point(155,186),new Point(157,185),new Point(159,184),new Point(156,185),new Point(154,
185),new Point(149,185),new Point(145,187),new Point(141,188),new Point(136,191),new Point(134,191),new Point(131,192),new Point(129,193),new Point(129,195),new Point(129,197),new Point(131,200),new Point(133,202),new Point(136,206),new Point(139,211),new Point(142,215),new Point(145,220),new Point(147,225),new Point(148,231),new Point(147,239),new Point(144,244),new Point(139,248),new Point(134,250),new Point(126,253),new Point(119,253),new Point(115,253)]));this.Unistrokes.push(new Unistroke("star",
[new Point(75,250),new Point(75,247),new Point(77,244),new Point(78,242),new Point(79,239),new Point(80,237),new Point(82,234),new Point(82,232),new Point(84,229),new Point(85,225),new Point(87,222),new Point(88,219),new Point(89,216),new Point(91,212),new Point(92,208),new Point(94,204),new Point(95,201),new Point(96,196),new Point(97,194),new Point(98,191),new Point(100,185),new Point(102,178),new Point(104,173),new Point(104,171),new Point(105,164),new Point(106,158),new Point(107,156),new Point(107,
152),new Point(108,145),new Point(109,141),new Point(110,139),new Point(112,133),new Point(113,131),new Point(116,127),new Point(117,125),new Point(119,122),new Point(121,121),new Point(123,120),new Point(125,122),new Point(125,125),new Point(127,130),new Point(128,133),new Point(131,143),new Point(136,153),new Point(140,163),new Point(144,172),new Point(145,175),new Point(151,189),new Point(156,201),new Point(161,213),new Point(166,225),new Point(169,233),new Point(171,236),new Point(174,243),new Point(177,
247),new Point(178,249),new Point(179,251),new Point(180,253),new Point(180,255),new Point(179,257),new Point(177,257),new Point(174,255),new Point(169,250),new Point(164,247),new Point(160,245),new Point(149,238),new Point(138,230),new Point(127,221),new Point(124,220),new Point(112,212),new Point(110,210),new Point(96,201),new Point(84,195),new Point(74,190),new Point(64,182),new Point(55,175),new Point(51,172),new Point(49,170),new Point(51,169),new Point(56,169),new Point(66,169),new Point(78,
168),new Point(92,166),new Point(107,164),new Point(123,161),new Point(140,162),new Point(156,162),new Point(171,160),new Point(173,160),new Point(186,160),new Point(195,160),new Point(198,161),new Point(203,163),new Point(208,163),new Point(206,164),new Point(200,167),new Point(187,172),new Point(174,179),new Point(172,181),new Point(153,192),new Point(137,201),new Point(123,211),new Point(112,220),new Point(99,229),new Point(90,237),new Point(80,244),new Point(73,250),new Point(69,254),new Point(69,
252)]));this.Unistrokes.push(new Unistroke("star",[new Point(75,250),new Point(75,247),new Point(77,244),new Point(78,242),new Point(79,239),new Point(80,237),new Point(82,234),new Point(82,232),new Point(84,229),new Point(85,225),new Point(87,222),new Point(88,219),new Point(89,216),new Point(91,212),new Point(92,208),new Point(94,204),new Point(95,201),new Point(96,196),new Point(97,194),new Point(98,191),new Point(100,185),new Point(102,178),new Point(104,173),new Point(104,171),new Point(105,
164),new Point(106,158),new Point(107,156),new Point(107,152),new Point(108,145),new Point(109,141),new Point(110,139),new Point(112,133),new Point(113,131),new Point(116,127),new Point(117,125),new Point(119,122),new Point(121,121),new Point(123,120),new Point(125,122),new Point(125,125),new Point(127,130),new Point(128,133),new Point(131,143),new Point(136,153),new Point(140,163),new Point(144,172),new Point(145,175),new Point(151,189),new Point(156,201),new Point(161,213),new Point(166,225),new Point(169,
233),new Point(171,236),new Point(174,243),new Point(177,247),new Point(178,249),new Point(179,251),new Point(180,253),new Point(180,255),new Point(179,257),new Point(177,257),new Point(174,255),new Point(169,250),new Point(164,247),new Point(160,245),new Point(149,238),new Point(138,230),new Point(127,221),new Point(124,220),new Point(112,212),new Point(110,210),new Point(96,201),new Point(84,195),new Point(74,190),new Point(64,182),new Point(55,175),new Point(51,172),new Point(49,170),new Point(51,
169),new Point(56,169),new Point(66,169),new Point(78,168),new Point(92,166),new Point(107,164),new Point(123,161),new Point(140,162),new Point(156,162),new Point(171,160),new Point(173,160),new Point(186,160),new Point(195,160),new Point(198,161),new Point(203,163),new Point(208,163),new Point(206,164),new Point(200,167),new Point(187,172),new Point(174,179),new Point(172,181),new Point(153,192),new Point(137,201),new Point(123,211),new Point(112,220),new Point(99,229),new Point(90,237),new Point(80,
244),new Point(73,250),new Point(69,254),new Point(69,252)].reverse()))}Recognize(a,b){if(0==a.length)return new Result("",0,0);var c=Date.now(),d=new Unistroke("",a);a=-1;for(var e=Infinity,f=0;f<this.Unistrokes.length;f++){var g=b?OptimalCosineDistance(this.Unistrokes[f].Vector,d.Vector):DistanceAtBestAngle(d.Points,this.Unistrokes[f],-AngleRange,+AngleRange,AnglePrecision);g<e&&(e=g,a=f)}d=Date.now();return-1==a?new Result("",0,d-c):new Result(this.Unistrokes[a].Name,b?1-e:1-e/HalfDiagonal,d-c)}AddGesture(a,
b){this.Unistrokes[this.Unistrokes.length]=new Unistroke(a,b);for(var c=b=0;c<this.Unistrokes.length;c++)this.Unistrokes[c].Name==a&&b++;return b}}function Resample(a,b){for(var c=PathLength(a)/(b-1),d=0,e=Array(a[0]),f=1;f<a.length;f++){var g=Distance(a[f-1],a[f]);d+g>=c?(d=new Point(a[f-1].x+(c-d)/g*(a[f].x-a[f-1].x),a[f-1].y+(c-d)/g*(a[f].y-a[f-1].y)),e[e.length]=d,a.splice(f,0,d),d=0):d+=g}e.length==b-1&&(e[e.length]=new Point(a[a.length-1].x,a[a.length-1].y));return e}
function IndicativeAngle(a){var b=Centroid(a);return Math.atan2(b.y-a[0].y,b.x-a[0].x)}function RotateBy(a,b){var c=Centroid(a),d=Math.cos(b);b=Math.sin(b);for(var e=[],f=0;f<a.length;f++)e[e.length]=new Point((a[f].x-c.x)*d-(a[f].y-c.y)*b+c.x,(a[f].x-c.x)*b+(a[f].y-c.y)*d+c.y);return e}function ScaleTo(a,b){for(var c=BoundingBox(a),d=[],e=0;e<a.length;e++)d[d.length]=new Point(b/c.Width*a[e].x,b/c.Height*a[e].y);return d}
function TranslateTo(a,b){for(var c=Centroid(a),d=[],e=0;e<a.length;e++)d[d.length]=new Point(a[e].x+b.x-c.x,a[e].y+b.y-c.y);return d}function Vectorize(a){for(var b=0,c=[],d=0;d<a.length;d++)c[c.length]=a[d].x,c[c.length]=a[d].y,b+=a[d].x*a[d].x+a[d].y*a[d].y;a=Math.sqrt(b);for(d=0;d<c.length;d++)c[d]/=a;return c}
function OptimalCosineDistance(a,b){for(var c=0,d=0,e=0;e<a.length;e+=2)c+=a[e]*b[e]+a[e+1]*b[e+1],d+=a[e]*b[e+1]-a[e+1]*b[e];a=Math.atan(d/c);return Math.acos(c*Math.cos(a)+d*Math.sin(a))}function DistanceAtBestAngle(a,b,c,d,e){for(var f=Phi*c+(1-Phi)*d,g=DistanceAtAngle(a,b,f),h=(1-Phi)*c+Phi*d,k=DistanceAtAngle(a,b,h);Math.abs(d-c)>e;)g<k?(d=h,h=f,k=g,f=Phi*c+(1-Phi)*d,g=DistanceAtAngle(a,b,f)):(c=f,f=h,g=k,h=(1-Phi)*c+Phi*d,k=DistanceAtAngle(a,b,h));return Math.min(g,k)}
function DistanceAtAngle(a,b,c){a=RotateBy(a,c);return PathDistance(a,b.Points)}function Centroid(a){for(var b=0,c=0,d=0;d<a.length;d++)b+=a[d].x,c+=a[d].y;b/=a.length;c/=a.length;return new Point(b,c)}function BoundingBox(a){for(var b=Infinity,c=-Infinity,d=Infinity,e=-Infinity,f=0;f<a.length;f++)b=Math.min(b,a[f].x),d=Math.min(d,a[f].y),c=Math.max(c,a[f].x),e=Math.max(e,a[f].y);return new Rectangle(b,d,c-b,e-d)}
function PathDistance(a,b){for(var c=0,d=0;d<a.length;d++)c+=Distance(a[d],b[d]);return c/a.length}function PathLength(a){for(var b=0,c=1;c<a.length;c++)b+=Distance(a[c-1],a[c]);return b}function Distance(a,b){var c=b.x-a.x;a=b.y-a.y;return Math.sqrt(c*c+a*a)}function Deg2Rad(a){return a*Math.PI/180}const _DollarRecognizer=DollarRecognizer,_Point=Point;var res,settings,loc,battle;const IDLE=0,PRE_ATTACK=1,ATTACK=2,POST_ATTACK=3,OWN_ATTACK=4,ACT=5,ITEMS=6,DRAW=7,DEAL=8,GAME_OVER=9,INTRO=10,CREDITS=11,STATE_NORMAL=0,STATE_HURT=1,STATE_ATTACKING=2,STATE_HANGING=3,STATE_DEAD=4,STATE_DRAW=6,STATE_BYE=7,STATE_SHIELDING=8,STATE_UNSHIELDING=9,STATE_BREAK=10,EFFECT_NONE=0,EFFECT_DRAWING_TIME=1,EFFECT_INVINSIBILITY=2,TEXT_COLORS=["#000000","#ff0000","#ff6a00","#ffffff","#0d85f3"];
class Sheet{constructor(a,b){this.imgReady=!1;this.imgUrl=a;this.img=new Image;this.img.src=this.imgUrl;this.img.onload=this.OnImageLoad.bind(this);this.img.onerror=this.Error.bind(this);this.jsonReady=!1;this.jsonUrl=b;this.json={};this.LoadJSON(this.jsonUrl);this.onerror=this.onload=null}LoadJSON(a){let b=new XMLHttpRequest;b.overrideMimeType("application/json");b.open("GET",a,!0);b.onreadystatechange=()=>{4==b.readyState&&(200==b.status?(this.json=JSON.parse(b.responseText),this.OnJSONLoad()):
this.Error())};b.onerror=this.Error;b.send()}OnImageLoad(a){this.imgReady=!0;this.AddReadyState();this.img.onload=null;this.img.onerror=null}OnJSONLoad(a){this.jsonReady=!0;this.AddReadyState();this.parts={};for(let c in this.json.frames){a=this.json.frames[c];var b=c.split("_");b=b.slice(0,b.length-1).join("_");this.parts[b]?this.parts[b].push(a):this.parts[b]=[a]}}GetTagFrame(a){a=this.GetTagFrames(a);return null==a?null:a[0]}GetTagFrames(a){let b=this.json.meta.frameTags.filter(d=>d.name==a);if(0==
b.length)return null;let c=[];for(let d=b[0].from;d<=b[0].to;d++)c.push(d);return c}Error(a){if(this.onerror)this.onerror()}Reload(){this.imgReady||(this.img.src=this.imgUrl+`?retry=${Date.now()}`);this.jsonReady||this.LoadJSON(this.jsonUrl+`?retry=${Date.now()}`)}AddReadyState(){if(this.imgReady&&this.jsonReady&&this.onload)this.onload()}DrawColored(a,b,c,d,e,f,g,h=-1,k=-1,m=!1,l=!1,n=0){c=this.parts[c];if(!(null==c||d>=c.length)){var p=c[d].frame;h=0<h?h:p.w;k=0<k?k:p.h;b.canvas.width=h;b.canvas.height=
k;e=m?e-h/2:e+c[d].spriteSourceSize.x;l?f-=k/2:l||(f+=c[d].spriteSourceSize.y);b.fillStyle=g;b.drawImage(this.img,p.x,p.y,p.w,p.h,0,0,h,k);b.globalCompositeOperation="source-in";b.fillRect(0,0,h,k);b.globalCompositeOperation="source-over";a.save();a.translate(e+h/2,f+k/2);a.rotate(n);a.drawImage(b.canvas,-h/2,-k/2,h,k);a.restore()}}Draw(a,b,c,d,e,f=-1,g=-1,h=!1,k=!1,m=0,l=!1){b=this.parts[b];if(!(null==b||c>=b.length)){var n=b[c].frame;f=0<f?f:n.w;g=0<g?g:n.h;h?d-=f/2:l||(d+=b[c].spriteSourceSize.x);
k?e-=g/2:l||(e+=b[c].spriteSourceSize.y);a.save();a.translate(d+f/2,e+g/2);a.rotate(m);a.drawImage(this.img,n.x,n.y,n.w,n.h,-f/2,-g/2,f,g);a.restore()}}}
class Sound{constructor(a,b,c,d,e){this.url=a;this.volume=b;this.speed=c;this.loop=d;this.music=e;this.ended=!0;this.audio=new Audio(this.url);this.audio.volume=this.volume;this.audio.defaultPlaybackRate=this.speed;this.audio.onended=this.Ended.bind(this);this.audio.load();this.audio.oncanplaythrough=this.Load.bind(this);this.audio.onerror=this.Error.bind(this);this.onerror=this.onload=null}Load(){if(this.onload)this.onload()}Error(){if(this.onerror)this.onerror()}Reload(){this.audio.src=this.url+
`?retry=${Date.now()}`}Ended(){this.ended=!0;this.loop&&(this.audio.currentTime=0,this.audio.play())}OnVolumeChange(){this.audio.volume=this.volume*(this.music?settings.bgmVolume:settings.sfxVolume)}play(){this.ended&&(this.audio.volume=this.volume*(this.music?settings.bgmVolume:settings.sfxVolume),this.audio.currentTime=0,this.audio.play(),this.ended=!1)}pause(){this.ended=!0;this.audio.pause()}}
class Locale{constructor(a){this.url=a;this.json={};this.Load(this.url);this.onerror=this.onload=null}GetString(a,b){if(this.json.groups[a][b])return this.json.groups[a][b];console.error(`\u043d\u0435\u0442 \u0441\u0442\u0440\u043e\u043a\u0438: ${b} [${a}]`);return b}GetDialogue(a,b){if(this.json.dialogue[a][b])return this.json.dialogue[a][b];console.error(`\u043d\u0435\u0442 \u0434\u0438\u0430\u043b\u043e\u0433\u0430: ${b} [${a}]`);return[b]}OnLoad(a){if(this.onload)this.onload()}Error(a){if(this.onerror)this.onerror()}Load(a){let b=
new XMLHttpRequest;b.overrideMimeType("application/json");b.open("GET",a,!0);b.onreadystatechange=()=>{4==b.readyState&&(200==b.status?(this.json=JSON.parse(b.responseText),this.OnLoad()):this.Error())};b.onerror=this.Error;b.send()}Reload(){this.Load(this.url+`?retry=${Date.now()}`)}}
class GameResources{constructor(){this.spritePrefix="./img/";this.spriteData={};this.sprites={};this.spriteNames={icons:"icons.png",buttons:"buttons.png",actions:"actions.png",items:"items.png",effects:"effects.png",soul:"soul.png",soulbreak:"soulbreak.png",ducky:"ducky.png",minipencil:"minipencil.png",card:"card.png",pencils:"pencils.png",scribble:"scribble.png",eat:"eat.png",chunks:"chunks.png",star:"star.png",ending:"ending.png"};this.sheetPrefix="./img/sheet/";this.sheetData={};this.sheets={};
this.sheetNames={duck:{img:"duck.png",json:"duck.json"},triangle:{img:"triangle.png",json:"triangle.json"},circle:{img:"circle.png",json:"circle.json"},star:{img:"star.png",json:"star.json"},patterns:{img:"patterns.png",json:"patterns.json"},popsicle:{img:"popsicle.png",json:"popsicle.json"},promo1:{img:"promo1.png",json:"promo1.json"},promo2:{img:"promo2.png",json:"promo2.json"},hands:{img:"hands.png",json:"hands.json"},story:{img:"story.png",json:"story.json"}};this.sfxPrefix="./sfx/";this.sfxData=
{};this.sfx={};this.sfxNames={intro:{url:"intro.mp3",music:!0},bgm:{url:"DUCKIDK2.mp3",loop:!0,volume:.7,music:!0},bgmGeno:{url:"DUCKGENO.mp3",loop:!0,volume:.7,music:!0},fail:{url:"fail.mp3",music:!0},check:{url:"check.mp3",volume:.8},duck:{url:"duck.mp3",volume:1},other:{url:"other.mp3",volume:.7},hurt:{url:"hurt.mp3",volume:.6},hurt2:{url:"hurt2.mp3",volume:.6},death:{url:"death.mp3",volume:.6},circle1:{url:"circle_1.mp3"},circle2:{url:"circle_2.mp3"},triangle1:{url:"triangle_1.mp3"},triangle2:{url:"triangle_2.mp3"},
star1:{url:"star_1.mp3"},star2:{url:"star_2.mp3"},click1:{url:"jump.mp3"},click2:{url:"jump2.mp3"},click3:{url:"jump4.mp3"},scribble1:{url:"scribble_1.mp3"},scribble2:{url:"scribble_2.mp3"},tick:{url:"tick.mp3"},hop:{url:"hop.mp3",volume:.5},hop2:{url:"hop2.mp3",volume:.6},crack:{url:"crack.mp3",volume:.8},break:{url:"break.mp3",volume:.5},warning:{url:"warning.mp3",volume:.7},heal:{url:"heal.mp3",volume:.8},effect:{url:"effect.mp3",volume:.5},effectEnd:{url:"effect_end.mp3",volume:.5},explosion:{url:"explosion.mp3",
volume:.5},chop:{url:"chop.mp3"},vroom:{url:"vroom.mp3"},gulp:{url:"gulp.mp3"}};this.locPrefix="./locale/";this.locData={};this.loc={};this.locNames={ru:"ru.json",en:"en.json"};this.ready=!1;this.onProgress=this.onReady=null}Load(){for(let c in this.spriteNames){var a=this.spriteNames[c];a="string"==typeof a?this.spritePrefix+a:this.spritePrefix+a.url;var b=new Image;b.src=a;this.spriteData[c]={url:a,src:b,loaded:!1,tries:0};this.sprites[c]=b;b.onload=()=>this.OnLoad(c,0);b.onerror=()=>this.OnError(c,
0)}for(let c in this.sheetNames)a=this.sheetNames[c],a=new Sheet(this.sheetPrefix+a.img,this.sheetPrefix+a.json),this.sheetData[c]={src:a,loaded:!1,tries:0},this.sheets[c]=a,a.onload=()=>this.OnLoad(c,2),a.onerror=()=>this.OnError(c,2);for(let c in this.sfxNames){b=this.sfxNames[c];let d=1,e=1,f=!1,g=!1;"string"==typeof b?a=this.sfxPrefix+b:(a=this.sfxPrefix+b.url,d=null!=b.volume?b.volume:1,f=null!=b.loop?b.loop:!1,e=null!=b.speed?b.speed:1,g=null!=b.music?b.music:!1);b=new Sound(a,d,e,f,g);this.sfxData[c]=
{url:a,src:b,loaded:!1,tries:0};this.sfx[c]=b;b.onload=()=>this.OnLoad(c,1);b.onerror=()=>this.OnError(c,1)}for(let c in this.locNames)a=new Locale(this.locPrefix+this.locNames[c]),this.locData[c]={src:a,loaded:!1,tries:0},this.loc[c]=a,a.onload=()=>this.OnLoad(c,3),a.onerror=()=>this.OnError(c,3)}OnError(a,b){let c;switch(b){case 0:c=this.spriteData[a];break;case 1:c=this.sfxData[a];break;case 2:c=this.sheetData[a];break;case 3:c=this.locData[a]}console.log(`${a} doesn't load (tries: ${c.tries})`);
3<=c.tries?alert(`\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0435 \u0440\u0435\u0441\u0443\u0440\u0441\u0430: ${a}`):(c.tries++,setTimeout(()=>this.Reload(c,b),1E3))}Reload(a,b){0==b?a.src.src=a.url+`?retry=${Date.now()}`:a.src.Reload()}OnLoad(a,b){let c;switch(b){case 0:c=this.spriteData[a];break;case 1:c=this.sfxData[a];break;case 2:c=this.sheetData[a];break;case 3:c=this.locData[a]}c.loaded=!0;c.src.onload=null;c.src.oncanplaythrough=null;
c.src.onerror=null;a=0;for(var d in this.spriteData)this.spriteData[d].loaded&&a++;for(let e in this.sfxData)this.sfxData[e].loaded&&a++;for(let e in this.sheetData)this.sheetData[e].loaded&&a++;for(let e in this.locData)this.locData[e].loaded&&a++;d=Object.keys(this.spriteData).length+Object.keys(this.sfxData).length+Object.keys(this.sheetData).length+Object.keys(this.locData).length;this.onProgress(a/d);if(a==d&&(this.ready=!0,this.onReady))this.onReady()}OnVolumeChange(a,b){for(let c in this.sfx)this.sfx[c].OnVolumeChange()}}
class Utils{static Random(a,b){return Math.random()*(b-a)+a}static RandomRound(a,b){return~~(Math.random()*(b-a)+a)}static RandomArray(a){return a[this.RandomRound(0,a.length)]}static Clamp(a,b,c){return a<b?b:a>c?c:a}static MousePosDOM(a,b){b=b.getBoundingClientRect();return{x:(a.clientX-b.left)/(b.right-b.left),y:(a.clientY-b.top)/(b.bottom-b.top)}}static MousePos(a,b){let c=b.getBoundingClientRect();return{x:(a.clientX-c.left)/(c.right-c.left)*b.width,y:(a.clientY-c.top)/(c.bottom-c.top)*b.height}}static LinearPos(a,
b,c){return{x:a.x+(b.x-a.x)*c,y:a.y+(b.y-a.y)*c}}static CurvePos(a,b,c,d){return{x:a.x+(b.x-a.x)*d,y:a.y+(b.y-a.y)*d-4*c*d*(1-d)}}static Lerp(a,b,c){return(1-c)*a+c*b}static Distance(a,b){var c=a.x-b.x;a=a.y-b.y;return Math.sqrt(c*c+a*a)}static BoundsEqual(a,b){return 1>=this.Distance({x:a.x1,y:a.y1},{x:b.x1,y:b.y1})&&1>=this.Distance({x:a.x2,y:a.y2},{x:b.x2,y:b.y2})}static RotatePoint(a,b,c){let d=Math.cos(c);c=Math.sin(c);return{x:b.x+(a.x-b.x)*d-(a.y-b.y)*c,y:b.y+(a.x-b.x)*c+(a.y-b.y)*d}}static Quadratic(a,
b,c,d){return b-((d-c)/(d-1))**2*(b-a)}static ReverseQuadratic(a,b,c,d){return this.Quadratic(a,b,d-c,d)}static MaskSprite(a,b,c,d,e,f,g,h,k,m,l,n){b.canvas.width=m;b.canvas.height=l;b.fillStyle=n;b.drawImage(c,d,e,f,g,0,0,m,l);b.globalCompositeOperation="source-in";b.fillRect(0,0,m,l);b.globalCompositeOperation="source-over";a.drawImage(b.canvas,h,k,m,l)}static RoundedRect(a,b,c,d,e,f){d<2*f&&(f=d/2);e<2*f&&(f=e/2);a.beginPath();a.moveTo(b+f,c);a.arcTo(b+d,c,b+d,c+e,f);a.arcTo(b+d,c+e,b,c+e,f);a.arcTo(b,
c+e,b,c,f);a.arcTo(b,c,b+d,c,f);a.closePath()}static SliceText(a,b,c){let d=[];for(let e in b){let f=b[e].split("~");for(let g in f){let h=f[g].split(" "),k=[],m=h[0];for(let l=1;l<h.length;l++){let n=h[l],p=a.measureText(m+" "+n).width;c.x1+p<c.x2?m+=" "+n:(k.push(m),m=n)}k.push(m);f[g]=k.join("\n")}d.push(f.join("~"))}return d}static TextHeight(a,b,c){a.font=`${c}px Pangolin`;a.textBaseline="top";c=b.split(/~|\n/).filter(d=>d);a=a.measureText(b);return(a.fontBoundingBoxAscent+a.fontBoundingBoxDescent)*
c.length}static GetAnimationFrame(a,b,c){return c[Math.round(a/b)%c.length]}}
class Settings{constructor(){this.sfxVolume=null!=localStorage.getItem("promoduck_sfx_volume")?localStorage.getItem("promoduck_sfx_volume")/100:1;this.bgmVolume=null!=localStorage.getItem("promoduck_bgm_volume")?localStorage.getItem("promoduck_bgm_volume")/100:1;this.movingBG=null!=localStorage.getItem("promoduck_moving_bg")?1==localStorage.getItem("promoduck_moving_bg"):!0;document.querySelector("#sfx_volume").addEventListener("input",this.OnVolumeChange.bind(this));document.querySelector("#sfx_volume").addEventListener("change",
a=>this.OnVolumeChange(a,!0));document.querySelector("#bgm_volume").addEventListener("input",this.OnVolumeChange.bind(this));document.querySelector("#bgm_volume").addEventListener("change",a=>this.OnVolumeChange(a,!0));document.querySelector("#moving_bg").addEventListener("input",this.OnMovingBGChange.bind(this));document.querySelector("#settings_open").addEventListener("click",this.Open.bind(this));document.querySelector("#settings_background").addEventListener("click",this.Close.bind(this));document.querySelector("#sfx_volume").value=
~~(100*this.sfxVolume);document.querySelector("#bgm_volume").value=~~(100*this.bgmVolume);document.querySelector("#moving_bg").checked=this.movingBG;this.UpdateRangeBackground(document.querySelector("#sfx_volume"),this.sfxVolume);this.UpdateRangeBackground(document.querySelector("#bgm_volume"),this.bgmVolume)}Start(){document.querySelector('label[for="sfx_volume"]').textContent=loc.Get("hud","sfx");document.querySelector('label[for="bgm_volume"]').textContent=loc.Get("hud","bgm");document.querySelector('label[for="moving_bg"]').textContent=
loc.Get("hud","moving_bg")}Open(){battle.mode.locked||battle.mode.drawingLocked||(document.querySelector("#settings").classList.contains("visible")?document.querySelector("#settings").classList.remove("visible"):document.querySelector("#settings").classList.add("visible"))}Close(){document.querySelector("#settings").classList.remove("visible")}OnVolumeChange(a,b){let c=!1,d=a.target.value/100;"sfx_volume"==a.target.id?(c=!1,this.sfxVolume=d,b&&localStorage.setItem("promoduck_sfx_volume",a.target.value)):
"bgm_volume"==a.target.id&&(c=!0,this.bgmVolume=d,b&&localStorage.setItem("promoduck_bgm_volume",a.target.value));this.UpdateRangeBackground(a.target,d);res.OnVolumeChange(c,d);b&&!c&&Utils.RandomArray([res.sfx.click1,res.sfx.click2,res.sfx.click3]).play()}UpdateRangeBackground(a,b){a=a.parentNode.querySelector(".progress_background");null!=a&&(a.style.width=`${100*b}%`)}OnMovingBGChange(a){this.movingBG=a.target.checked;localStorage.setItem("promoduck_moving_bg",this.movingBG?1:0)}}
class Localization{constructor(){this.language="ru"}Get(a,b){return res.loc[this.language].GetString(a,b)}Dial(a,b){return[...res.loc[this.language].GetDialogue(a,b)]}}let started=!1;window.addEventListener("click",a=>{started||res.ready&&Start()});window.addEventListener("load",()=>{res=new GameResources;res.Load();loc=new Localization;settings=new Settings;res.onReady=Ready;res.onProgress=Progress});
function Ready(){settings.Start();document.querySelector("#progress").textContent=loc.Get("hud","click_to_start")}function Start(){started=!0;document.querySelector(".preloader").style.display="none";battle=new Battle;battle.Start()}function Restart(){for(let a in res.sfx){let b=res.sfx[a];b.pause();b.ended=!0}null!=battle&&battle.Destroy();battle=new Battle;battle.Start(!0)}function Progress(a){document.querySelector("#progress").textContent=`${~~(100*a)}%`};class Item{constructor(a){this.id=a;this.hp=-1;this.consumed=0;this.maxConsume=1;this.effect=EFFECT_NONE;this.effectTurns=0;this.name=loc.Get("items","nothing");this.index={x:0,y:0};this.text=loc.Dial("items","nothing")}Consume(){this.consumed++;0<this.hp?(battle.hp=Math.min(battle.hp+this.hp,battle.maxHP),res.sfx.heal.play()):this.effect!=EFFECT_NONE&&(battle.AddEffect(this.effect,this.effectTurns),res.sfx.effect.play());let a={text:this.text};a.speech=battle.enemies[0].StoryFlow();return a}IsAvailable(){return this.consumed<
this.maxConsume}}class Sharpener extends Item{constructor(){super(0);this.hp=7;this.maxConsume=4;this.name=loc.Get("items","sharpener");this.index={x:0,y:0};this.text=loc.Dial("items","sharpener")}Consume(){if(battle.soul.eaten)return{text:loc.Dial("items","sharpener_fail")};let a=super.Consume();switch(this.consumed){case 2:a.text=loc.Dial("items","sharpener_1");break;case 3:a.text=loc.Dial("items","sharpener_2");break;case 4:a.text=loc.Dial("items","sharpener_3")}return a}}
class RubberBand extends Item{constructor(){super(1);this.hp=0;this.effect=EFFECT_DRAWING_TIME;this.effectTurns=5;this.name=loc.Get("items","rubber_band");this.index={x:1,y:0};this.text=loc.Dial("items","rubber_band")}Consume(){return battle.soul.eaten?{text:loc.Dial("items","rubber_band_fail")}:super.Consume()}}
class GhostCandy extends Item{constructor(){super(1);this.hp=0;this.maxConsume=2;this.effect=EFFECT_INVINSIBILITY;this.effectTurns=3;this.name=loc.Get("items","ghost_candy");this.index={x:0,y:1};this.text=loc.Dial("items","ghost_candy")}Consume(){let a=super.Consume();switch(this.consumed){case 1:a.text=loc.Dial("items","ghost_candy_1");break;case 2:a.text=loc.Dial("items","ghost_candy_2")}battle.soul.eaten||(a.text[0]+=this.text[0]);return a}};class BattleMode{constructor(a){this.id=a;this.locked=!1}Start(){}GameLoop(a){}Render(a,b){}PointerDown(a){}PointerUp(a){}PointerMove(a){}}
class TargettedBattleMode extends BattleMode{constructor(a){super(a);this.enemies=[];this.targetClickTarget=this.targetEnemy=null;this.enemySelection=!0}Start(){this.locked=!1;this.enemySelection=!0;this.enemies=[];for(var a in battle.enemies){var b=battle.enemies[a];b.alive&&this.enemies.push({data:b})}a=Math.min(100,(battle.defaultBounds.y2-battle.defaultBounds.y1-100-25*(this.enemies.length-1))/this.enemies.length);for(let c in this.enemies)b=this.enemies[c],b.x=battle.defaultBounds.x1+(battle.defaultBounds.x2-
battle.defaultBounds.x1)/2-140,b.y=battle.defaultBounds.y1+(battle.defaultBounds.y2-battle.defaultBounds.y1)/2+c*(a+25)-a/2+10,b.w=280,b.h=a}SelectTarget(a){this.targetEnemy=a;this.enemySelection=!1}Back(){battle.Idle()}TargetEnemy(){for(let a in this.enemies)if(battle.mousePos.x>=this.enemies[a].x&&battle.mousePos.x<=this.enemies[a].x+this.enemies[a].w&&battle.mousePos.y>=this.enemies[a].y&&battle.mousePos.y<=this.enemies[a].y+this.enemies[a].h)return this.enemies[a];return null}PointerDown(a){this.targetClickTarget=
this.TargetEnemy();null==this.targetClickTarget&&battle.ui.PointerDown(a)}PointerUp(a){let b=this.TargetEnemy();b==this.targetClickTarget&&null!=b?(Utils.RandomArray([res.sfx.click1,res.sfx.click2,res.sfx.click3]).play(),this.SelectTarget(b.data)):battle.ui.PointerUp(a);this.targetClickTarget=null}Render(a,b){a.font="36px Pangolin";a.textAlign="center";a.textBaseline="top";a.fillStyle="#666";a.fillText(loc.Get("hud","target"),battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,battle.bounds.y1+
15+4);a.strokeStyle=battle.theme.Outline();a.textAlign="left";a.textBaseline="middle";a.lineWidth=3;b=this.TargetEnemy();for(let c in this.enemies){let d=this.enemies[c];a.strokeStyle=d==b?a.fillStyle="#0d85f3":a.fillStyle=battle.theme.Outline();a.save();a.beginPath();Utils.RoundedRect(a,d.x,d.y,d.w,d.h,4);a.clip();a.fillText(d.data.name,d.x+75+5,d.y+d.h/2);Utils.MaskSprite(a,battle.tempCtx,res.sprites.icons,100*d.data.index.x,100*d.data.index.y,100,100,d.x+15,d.y-25+d.h/2,50,50,a.fillStyle);a.fillStyle=
d==b?"#B3C9DB":"#aaa";a.fillRect(d.x,d.y+d.h-15,d.w,15);a.fillStyle=d==b?"#0d85f3":battle.theme.Outline();a.fillRect(d.x,d.y+d.h-15,d.w*d.data.hp/d.data.maxHP,15);a.stroke();a.closePath();a.restore()}}}
class IdleMode extends BattleMode{constructor(){super(IDLE);this.typeWriter=new TypeWriter(null,!1)}Start(){let a=battle.enemies[0].Idle();this.typeWriter.Start();this.typeWriter.SetText(a.text)}GameLoop(a){battle.boundsReady&&this.typeWriter.GameLoop(a)}Render(a,b){battle.boundsReady&&this.typeWriter.Render(a,b)}PointerDown(a){battle.mousePos.y<battle.defaultBounds.y2+70||battle.mousePos.y>battle.defaultBounds.y2+70+70||battle.mousePos.x<battle.defaultBounds.x1||battle.mousePos.x>battle.defaultBounds.x2?
this.typeWriter.PointerUp(a):battle.ui.PointerDown(a)}PointerUp(a){battle.ui.PointerUp(a)}}
class DrawingMode extends TargettedBattleMode{constructor(a){super(a);this.castTime=this.defaultCastTime=80;this.lineWidth=5;this.color="#000000";this.text=loc.Get("hud","draw")}Start(){battle.HasEffect(EFFECT_DRAWING_TIME)?this.castTime=2*this.defaultCastTime:this.castTime=this.defaultCastTime;this.castTimer=0;this.drawing=this.drawingLocked=!1;this.drawnPoints=[]}GameLoop(a){this.drawing&&(this.castTimer-=1*a,1>this.castTimer%16&&res.sfx.tick.play(),0>=this.castTimer&&this.Finish())}static DrawLine(a,
b,c,d=5,e="#000"){a.lineWidth=d;a.strokeStyle=e;a.beginPath();d=[...b];0<b.length&&null!=c&&d.push(c);for(e=1;e<d.length;e++){let f=d[e].x,g=d[e].y,h=d[e-1].x,k=d[e-1].y;h==f&&k==g&&(h+=.01,k+=.01);a.quadraticCurveTo(h,k,(f+h)/2,(g+k)/2)}0<b.length&&null!=c&&a.lineTo(c.x,c.y);null==c&&a.lineTo(d[d.length-1].x,d[d.length-1].y);a.stroke();a.closePath()}Render(a,b){if(this.enemySelection)super.Render(a,b);else{b=this.color;"#000000"==this.color&&(b=battle.theme.Outline());DrawingMode.DrawLine(a,this.drawnPoints,
{x:battle.soul.x,y:battle.soul.y},this.lineWidth,b);a.font="36px Pangolin";b=this.text;var c=a.measureText(b).width+24;this.drawing&&(c=40,b=`${~~(this.castTimer/16)+1}`);1>battle.bounds.a&&(a.fillStyle="#fff",a.beginPath(),Utils.RoundedRect(a,battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2-c/2,battle.bounds.y1+10,c,48,6),a.fill(),a.closePath());c=battle.bounds.y1+15+4;this.drawing&&4>this.castTimer%16&&(a.font="38px Pangolin",--c);a.fillStyle="#666";a.textAlign="center";a.textBaseline="top";
a.fillText(b,battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,c)}}PointerDown(a){this.enemySelection?super.PointerDown(a):battle.IsCursorInsideBounds()?(this.drawingLocked=!0,this.castTimer=this.castTime,this.drawing=!0,this.drawnPoints=[],battle.TeleportSoulToCursor(a),this.AddPoint()):this.locked||battle.ui.PointerDown(a)}PointerUp(a){this.enemySelection?super.PointerUp(a):(this.AddPoint(),this.drawing?this.Finish():this.locked||battle.ui.PointerUp(a),this.drawing=!1,this.drawnPoints=[])}PointerMove(a){this.AddPoint()}AddPoint(a=
!1){if(!this.pending&&this.drawing){var b={x:~~battle.soul.x,y:~~battle.soul.y};(0==this.drawnPoints.length||a||15<=Utils.Distance(this.drawnPoints[this.drawnPoints.length-1],b))&&this.drawnPoints.push(b)}}Finish(){this.drawing=!1;this.drawnPoints=[];battle.DecreaseEffectTurns(EFFECT_DRAWING_TIME)}}
class OwnAttackMode extends DrawingMode{constructor(){super(OWN_ATTACK);this.dollar=new DollarRecognizer;this.pendingTime=130;this.transformTime=50;this.damageTime=this.flyTime=20;this.shakeTime=40;this.pendingTimer=0;this.pending=!1;this.currentAttack=null;this.attackDamage=0;this.attackAnimation=this.attackType=null;this.soundPlayed=!1}Start(){super.Start();this.locked=!1;this.SelectTarget(battle.enemies[0]);this.attackType=Object.values(battle.ownAttacks)[battle.ownAttackIndex];this.attackAnimations=
{drawing:this.attackType.sheet.GetTagFrames("drawing"),attack:this.attackType.sheet.GetTagFrames("transform"),loop:this.attackType.sheet.GetTagFrames("loop"),failure:this.attackType.sheet.GetTagFrames("failure")}}SelectTarget(a){super.SelectTarget(a);battle.SetBounds({x1:515,y1:300,x2:765,y2:550,a:1})}Render(a,b){this.enemySelection||this.pending||null==this.attackType||(a.globalAlpha=.5,this.attackType.sheet.DrawColored(a,battle.tempCtx,"attack",Utils.GetAnimationFrame(b,200,this.attackAnimations.drawing),
battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2,battle.theme.Outline(),-1,-1,!0,!0),a.globalAlpha=1);if(this.pending)if(0>=this.attackDamage)if(this.pendingTimer<=this.transformTime)b=Utils.Clamp(this.pendingTimer/this.transformTime,0,1),this.attackType.sheet.DrawColored(a,battle.tempCtx,"attack",this.attackAnimations.failure[Math.round((this.attackAnimations.failure.length-1)*b)],battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,
battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2,battle.theme.Outline(),-1,-1,!0,!0);else{b=Utils.Clamp((this.pendingTimer-this.transformTime)/(this.flyTime+this.damageTime),0,1);var c=Utils.CurvePos({x:0,y:battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2},{x:0,y:a.canvas.height+150},300,b);a.save();a.translate(battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,c.y);a.rotate(Math.PI*b);this.attackType.sheet.DrawColored(a,battle.tempCtx,"attack",this.attackAnimations.failure[Math.round(3*
(this.attackAnimations.failure.length-1)*b)%this.attackAnimations.failure.length],0,0,battle.theme.Outline(),-1,-1,!0,!0);a.restore()}else if(this.pendingTimer<=this.transformTime)b=Utils.Clamp(this.pendingTimer/this.transformTime,0,1),this.attackType.sheet.Draw(a,"attack",this.attackAnimations.attack[Math.round((this.attackAnimations.attack.length-1)*b)],battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2,-1,-1,!0,!0);else if(this.pendingTimer-
this.transformTime<=this.flyTime)b=Utils.Clamp((this.pendingTimer-this.transformTime)/this.flyTime,0,1),this.attackType.sheet.Draw(a,"attack",this.attackAnimations.loop[Math.round(2*(this.attackAnimations.loop.length-1)*b)%this.attackAnimations.loop.length],battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2+(this.targetEnemy.sprite.y+this.targetEnemy.sprite.pivot.y-50-(battle.bounds.y1+(battle.bounds.y2-battle.defaultBounds.y1)/2-50))*b,-1,
-1,!0,!0);else{var d=battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2-100;b=battle.bounds.y1-50;a.save();a.beginPath();Utils.RoundedRect(a,d,b,200,32,6);a.clip();a.fillStyle="#000";a.fillRect(d,b,200,32);a.fillStyle="#0d85f3";c=Utils.Clamp((this.pendingTimer-this.transformTime-this.flyTime)/this.damageTime,0,1);let e=this.hpBeforeAttack-(this.hpBeforeAttack-this.targetEnemy.hp)*c,f=200*e/this.targetEnemy.maxHP;0<e&&(f=Math.max(f,5));a.fillRect(d,b,f,32);a.restore();a.strokeStyle="#000";a.stroke();
a.closePath();d=this.attackDamage/this.currentAttack.damage;a.fillStyle=.9<d?"#fff":.5<d?"#aaa":"#808080";a.textAlign="center";a.textBaseline="bottom";a.strokeStyle="#000";a.lineWidth=5;a.font="50px Pangolin";b=Utils.CurvePos({x:0,y:b+10},{x:0,y:b},25,c);a.strokeText(`${this.attackDamage}`,battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,b.y);a.fillText(`${this.attackDamage}`,battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,b.y);c=Utils.Clamp((this.pendingTimer-this.transformTime-this.flyTime)/
this.shakeTime,0,1);this.targetEnemy.sprite.SetAnimation(STATE_HURT,1-c)}else super.Render(a,b)}GameLoop(a){super.GameLoop(a);this.pending&&(this.pendingTimer<=this.pendingTime?this.pendingTimer+=1*a:(this.pending=!1,this.targetEnemy.sprite.SetAnimation(STATE_NORMAL,0),battle.OnOwnAttackEnd(),this.currentAttack=null));this.pending&&this.pendingTimer-this.transformTime>=this.flyTime&&this.HurtAnimationEnd();this.pending&&this.pendingTimer>=this.transformTime&&!this.soundPlayed&&(this.soundPlayed=!0,
null!=this.currentAttack.sfx&&1<this.currentAttack.sfx.length&&0<this.attackDamage?this.currentAttack.sfx[1].play():0>=this.attackDamage&&res.sfx.scribble2.play())}PointerDown(a){this.pending||super.PointerDown(a)}PointerUp(a){this.pending||super.PointerUp(a)}HurtAnimationEnd(){if(!this.hurtAnimationFinished){this.hurtAnimationFinished=!0;0<this.attackDamage&&Utils.RandomArray([res.sfx.hurt,res.sfx.hurt2]).play();var a=this.targetEnemy.Hurt(this.attackDamage);battle.lastActionResult={...a,target:this.targetEnemy}}}Finish(){this.AddPoint(!0);
this.hpBeforeAttack=this.targetEnemy.hp;let a=this.dollar.Recognize(this.drawnPoints,!1),b=battle.ownAttacks[a.Name],c=!1;b&&a.Name==Object.keys(battle.ownAttacks)[battle.ownAttackIndex]||(c=!0);c&&(b=battle.ownAttacks[""]);let d=0,e=0;c||(d=~~(b.damage*a.Score),e=Math.max(~~(b.damage/2*(this.castTimer/this.castTime)),0));this.attackDamage=this.targetEnemy.DealDamage(d+e);this.pending=!0;this.currentAttack=b;this.soundPlayed=!1;null!=this.currentAttack.sfx&&0<this.currentAttack.sfx.length&&0<this.attackDamage?
this.currentAttack.sfx[0].play():0>=this.attackDamage&&res.sfx.scribble1.play();this.pendingTimer=0;this.hurtAnimationFinished=!1;super.Finish()}}
class PreAttackMode extends BattleMode{constructor(){super(PRE_ATTACK);this.typeWriter=new TypeWriter(null,!0);this.speechActive=this.typeWriterActive=!1}Start(){this.locked=!0;this.speechActive=this.typeWriterActive=!1;battle.lastActionResult.text?this.StartTypeWriter():battle.lastActionResult.speech?this.StartSpeech():battle.Attack()}StartTypeWriter(){battle.lastActionResult.text&&(battle.ResetBounds(),this.typeWriter.Start(),this.typeWriter.SetText(battle.lastActionResult.text),this.typeWriterActive=
!0)}StartSpeech(){battle.lastActionResult.speech&&(this.speechActive=!0,battle.enemies[0].sprite.SetSpeechBubble(battle.lastActionResult.speech,battle.lastActionResult.actions?battle.lastActionResult.actions:[]))}PointerUp(a){this.typeWriterActive?this.typeWriter.PointerUp(a):this.speechActive&&battle.enemies[0].sprite.speechBubble.PointerUp(a)}GameLoop(a){this.typeWriterActive?this.typeWriter.finished?this.speechActive||(this.typeWriterActive=!1,this.StartSpeech()):battle.boundsReady&&this.typeWriter.GameLoop(a):
(this.speechActive&&!battle.enemies[0].sprite.speaking&&(this.speechActive=!1),this.typeWriterActive||this.speechActive||(null!=battle.lastActionResult.mode?battle.SetMode(battle.lastActionResult.mode):battle.Attack()))}Render(a,b){battle.boundsReady&&this.typeWriterActive&&this.typeWriter.Render(a,b)}}
class PostAttackMode extends BattleMode{constructor(){super(POST_ATTACK)}Start(){this.locked=!0;battle.lastActionResult.speech&&battle.enemies[0].sprite.SetSpeechBubble(battle.lastActionResult.speech,battle.lastActionResult.actions?battle.lastActionResult.actions:[])}PointerUp(a){battle.enemies[0].sprite.speechBubble.PointerUp(a)}GameLoop(a){battle.enemies[0].sprite.speaking||battle.Idle()}}class AttackMode extends BattleMode{constructor(){super(ATTACK)}Start(){this.locked=!0}}
class ActMode extends TargettedBattleMode{constructor(){super(ACT);this.clickTarget=null;this.actions=[];this.selectedAction=null;this.typeWriter=new TypeWriter(null,!0)}Start(){super.Start();this.SelectTarget(battle.enemies[0]);battle.ResetBounds(!1,!0);this.typeWriter.Start();this.selectedAction=null}SelectTarget(a){super.SelectTarget(a);this.actions=[];for(var b in this.targetEnemy.actions)this.actions.push({...this.targetEnemy.actions[b]});a=(battle.defaultBounds.x2-battle.defaultBounds.x1)/2-
18.75;b=Math.min(85,(battle.defaultBounds.y2-battle.defaultBounds.y1)/Math.ceil(this.actions.length/2)-18.75);for(let c in this.actions){let d=this.actions[c],e=c%2,f=~~(c/2);d.x=battle.defaultBounds.x1+e*a+12.5*(e+1);d.y=battle.defaultBounds.y1+f*b+12.5*(f+1);d.w=a;d.h=b}}TargetAction(){if(battle.mousePos.x<battle.defaultBounds.x1||battle.mousePos.x>battle.defaultBounds.x2||battle.mousePos.y<battle.defaultBounds.y1||battle.mousePos.y>battle.defaultBounds.y2)return null;for(let a in this.actions)if(battle.mousePos.x>=
this.actions[a].x&&battle.mousePos.x<=this.actions[a].x+this.actions[a].w&&battle.mousePos.y>=this.actions[a].y&&battle.mousePos.y<=this.actions[a].y+this.actions[a].h)return this.actions[a];return null}GameLoop(a){null!=this.selectedAction&&(this.typeWriter.GameLoop(a),this.typeWriter.finished&&(this.selectedAction=null,battle.PreAttack()))}PointerDown(a){this.enemySelection?super.PointerDown(a):null==this.selectedAction&&(this.clickTarget=this.TargetAction(),null==this.clickTarget&&battle.ui.PointerDown(a))}PointerUp(a){if(this.enemySelection)super.PointerUp(a);
else if(null!=this.selectedAction)this.typeWriter.PointerUp(a);else{var b=this.TargetAction();b&&b==this.clickTarget?(Utils.RandomArray([res.sfx.click1,res.sfx.click2,res.sfx.click3]).play(),this.selectedAction=b,(a=this.selectedAction.action())&&a.text||console.error("\u0432\u0441\u0451 \u043f\u043e\u0435\u0445\u0430\u043b\u043e \u0432 \u0436\u043e\u043f\u0443!!!",this.selectedAction),this.typeWriter.SetText(a.text),battle.lastActionResult={...a,target:this.targetEnemy},delete battle.lastActionResult.text,
this.locked=!0):battle.ui.PointerUp(a);this.clickTarget=null}}Render(a,b){if(this.enemySelection)super.Render(a,b);else if(null==this.selectedAction){a.strokeStyle=battle.theme.Outline();a.fillStyle=battle.theme.Outline();a.font="36px Pangolin";a.textBaseline="middle";a.textAlign="left";a.lineWidth=2;b=this.TargetAction();for(let c in this.actions){let d=this.actions[c];a.strokeStyle=d.highlighted?d==b?a.fillStyle="#FFC13D":a.fillStyle="#ff6a00":d==b?a.fillStyle="#0d85f3":a.fillStyle=battle.theme.Outline();
a.beginPath();Utils.RoundedRect(a,d.x,d.y,d.w,d.h,4);a.stroke();a.closePath();Utils.MaskSprite(a,battle.tempCtx,res.sprites.actions,50*d.index.x,50*d.index.y,50,50,d.x+15,d.y-25+d.h/2,50,50,a.fillStyle);a.fillText(d.name,d.x+50+35,d.y+d.h/2)}}else this.typeWriter.Render(a,b)}}
class DrawMode extends DrawingMode{constructor(){super(DRAW);this.lineWidth=5;this.color="#ff0000"}Start(){super.Start();this.locked=!0;this.SelectTarget(battle.lastActionResult.target);this.targetEnemy.sprite.positionLocked=!0;this.lineWidth=Utils.RandomRound(5,20);this.color=`hsl(${40*Utils.RandomRound(0,9)}, 100%, 50%)`;battle.SetBounds({x1:battle.defaultBounds.x1-25,y1:15,x2:battle.defaultBounds.x1+295,y2:290,a:0},!0)}PointerDown(a){battle.IsCursorInsideBounds()&&(3<this.targetEnemy.wtf?this.targetEnemy.sprite.SetExpression("B"):
this.targetEnemy.sprite.SetExpression("8"),super.PointerDown(a))}Finish(){this.AddPoint(!0);delete battle.lastActionResult.mode;let a=[];for(let b in this.drawnPoints)a.push({x:this.drawnPoints[b].x-(battle.defaultBounds.x1-55),y:this.drawnPoints[b].y});DrawingMode.DrawLine(this.targetEnemy.sprite.vandalismCtx,a,null,this.lineWidth,this.color);battle.lastActionResult={...this.targetEnemy.Drawn(this.drawnPoints.length),target:this.targetEnemy};battle.SetMode(PRE_ATTACK);super.Finish()}}
class DealMode extends DrawingMode{constructor(){super(DEAL);this.text=loc.Get("hud","deal")}Start(){super.Start();this.locked=!0;this.SelectTarget(battle.lastActionResult.target);let a={x1:415,y1:300,x2:865,y2:550,a:1};this.yesBounds={x1:a.x1+80,y1:a.y1+(a.y2-a.y1)/2-25};this.yesBounds.x2=this.yesBounds.x1+50;this.yesBounds.y2=this.yesBounds.y1+50;this.noBounds={x1:a.x2-150-50,y1:a.y1+(a.y2-a.y1)/2-25};this.noBounds.x2=this.noBounds.x1+50;this.noBounds.y2=this.noBounds.y1+50;this.targetEnemy.dumbBaby&&
(this.yesBounds={...a},this.noBounds.x1=a.x2+150,this.noBounds.x2=a.x2+150+50);battle.SetBounds(a)}PointerDown(a){battle.IsCursorInsideBounds()&&super.PointerDown(a)}Render(a,b){a.strokeStyle="#666";a.lineWidth=3;a.strokeRect(this.yesBounds.x1,this.yesBounds.y1,this.yesBounds.x2-this.yesBounds.x1,this.yesBounds.y2-this.yesBounds.y1);a.strokeRect(this.noBounds.x1,this.noBounds.y1,this.noBounds.x2-this.noBounds.x1,this.noBounds.y2-this.noBounds.y1);a.fillStyle="#666";a.font="36px Pangolin";a.textAlign=
"left";a.textBaseline="middle";a.fillText(loc.Get("hud","yes"),this.yesBounds.x2+12,this.yesBounds.y1+(this.yesBounds.y2-this.yesBounds.y1)/2);a.fillText(loc.Get("hud","no"),this.noBounds.x2+12,this.noBounds.y1+(this.noBounds.y2-this.noBounds.y1)/2);a.font="8px Pangolin";a.textBaseline="bottom";let c=loc.Dial("duck","disclaimer");for(let d in c)a.fillText(c[d],battle.bounds.x1+12,battle.bounds.y2-12*(c.length-d));super.Render(a,b)}Finish(){let a=!1,b=!1,c=0;for(let d in this.drawnPoints){let e=this.drawnPoints[d];
e.x>=this.yesBounds.x1&&e.x<=this.yesBounds.x2&&e.y>=this.yesBounds.y1&&e.y<=this.yesBounds.y2?a=!0:e.x>=this.noBounds.x1&&e.x<=this.noBounds.x2&&e.y>=this.noBounds.y1&&e.y<=this.noBounds.y2?b=!0:c++}battle.lastActionResult={...this.targetEnemy.Deal(a,b,this.drawnPoints.length,c),target:this.targetEnemy};battle.SetMode(PRE_ATTACK);super.Finish()}}
class ItemsMode extends BattleMode{constructor(){super(ITEMS);this.locked=!1;this.clickTarget=null;this.items=[];this.selectedItem=null;this.typeWriter=new TypeWriter(null,!0)}Start(){this.locked=!1;battle.ResetBounds(!1,!0);this.typeWriter.Start();this.items=[];for(var a in battle.inventory)this.items.push({data:battle.inventory[a]});a=(battle.defaultBounds.x2-battle.defaultBounds.x1)/2-18.75;let b=Math.min(85,(battle.defaultBounds.y2-battle.defaultBounds.y1)/Math.ceil(this.items.length/2)-18.75);
for(let c in this.items){let d=this.items[c],e=c%2,f=~~(c/2);d.x=battle.defaultBounds.x1+e*a+12.5*(e+1);d.y=battle.defaultBounds.y1+f*b+12.5*(f+1);d.w=a;d.h=b}}TargetItem(){if(battle.mousePos.x<battle.defaultBounds.x1||battle.mousePos.x>battle.defaultBounds.x2||battle.mousePos.y<battle.defaultBounds.y1||battle.mousePos.y>battle.defaultBounds.y2)return null;for(let a in this.items)if(battle.mousePos.x>=this.items[a].x&&battle.mousePos.x<=this.items[a].x+this.items[a].w&&battle.mousePos.y>=this.items[a].y&&
battle.mousePos.y<=this.items[a].y+this.items[a].h)return this.items[a];return null}GameLoop(a){null!=this.selectedItem&&(this.typeWriter.GameLoop(a),this.typeWriter.finished&&(this.selectedItem=null,battle.PreAttack()))}PointerDown(a){null==this.selectedItem&&(this.clickTarget=this.TargetItem(),null==this.clickTarget&&battle.ui.PointerDown(a))}PointerUp(a){if(null!=this.selectedItem)this.typeWriter.PointerUp(a);else{var b=this.TargetItem();b&&b==this.clickTarget?(Utils.RandomArray([res.sfx.click1,
res.sfx.click2,res.sfx.click3]).play(),this.selectedItem=b,a=this.selectedItem.data,b=a.Consume(),a.IsAvailable()||battle.inventory.splice(battle.inventory.indexOf(a),1),this.typeWriter.SetText(b.text),battle.lastActionResult={...b,target:battle.enemies[0]},delete battle.lastActionResult.text,this.locked=!0):battle.ui.PointerUp(a);this.clickTarget=null}}Render(a,b){if(null==this.selectedItem)if(a.strokeStyle=battle.theme.Outline(),a.fillStyle=battle.theme.Outline(),a.textBaseline="middle",a.lineWidth=
2,0==this.items.length)a.fillStyle="#666",a.textAlign="center",a.font="36px Pangolin",a.fillText(loc.Get("hud","empty"),battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2);else{b=this.TargetItem();for(let c in this.items){let d=this.items[c];a.font="36px Pangolin";a.strokeStyle=d==b?a.fillStyle="#0d85f3":a.fillStyle=battle.theme.Outline();a.beginPath();Utils.RoundedRect(a,d.x,d.y,d.w,d.h,4);a.stroke();a.closePath();Utils.MaskSprite(a,battle.tempCtx,
res.sprites.items,50*d.data.index.x,50*d.data.index.y,50,50,d.x+15,d.y-25+d.h/2,50,50,a.fillStyle);let e=d.data.name,f=a.measureText(e).width;a.textAlign="left";a.fillText(e,d.x+50+35,d.y+d.h/2);d.data.effect==EFFECT_NONE&&0<d.data.hp?(a.textAlign="right",a.fillText(`+${d.data.hp}`,d.x+d.w-15-24-6,d.y+d.h/2),Utils.MaskSprite(a,battle.tempCtx,res.sprites.effects,0,0,24,24,d.x+d.w-24-15,d.y+d.h/2-12-2,24,24,a.fillStyle)):(a.textAlign="right",a.fillText(`+${d.data.effectTurns}`,d.x+d.w-15-24-6,d.y+d.h/
2),Utils.MaskSprite(a,battle.tempCtx,res.sprites.effects,24*d.data.effect,0,24,24,d.x+d.w-24-15,d.y+d.h/2-12-2,24,24,a.fillStyle));1<d.data.maxConsume&&(a.font="30px Pangolin",a.textAlign="left",a.fillStyle=d==b?"#8497A8":"#666",a.fillText(`x${d.data.maxConsume-d.data.consumed}`,d.x+50+35+f+15,d.y+d.h/2))}}else this.typeWriter.Render(a,b)}Back(){battle.Idle()}}
class GameOverMode extends BattleMode{constructor(){super(GAME_OVER);this.silentTime=30;this.shakeTime=60;this.showTextTime=120;this.showMockeryTime=200;this.showRetryTime=300;this.breakSpeed=30;this.breakDelay=2;this.showTextSpeed=100;this.showRetrySpeed=50;this.soundPlayed=!1;this.animationTimer=0;this.typeWriter=new TypeWriter(null,!1,res.sfx.duck);this.flavorText=loc.Dial("duck","game_over")}Start(){res.sfx.bgm.pause();res.sfx.bgmGeno.pause();this.soulPos={x:battle.soul.x,y:battle.soul.y};this.retryButton=
{x:battle.canvas.width/2-140,y:battle.canvas.height-100,w:280,h:70};this.soundPlayed=!1;this.animationTimer=0;this.typeWriter.Start();battle.ctx.font=`${this.typeWriter.textSize}px Pangolin`;let a=Utils.RandomArray(this.flavorText),b=battle.ctx.measureText(a.split("~")[0]).width;this.typeWriter.textBounds.y1=380;this.typeWriter.textBounds.x1=(battle.canvas.width-b)/2;this.typeWriter.textBounds.x2=battle.canvas.width;this.typeWriter.SetText([`@3${a}@`])}GameLoop(a){this.animationTimer>this.showMockeryTime&&
this.typeWriter.GameLoop(a);this.animationTimer+=1*a;this.animationTimer>=this.shakeTime&&!this.soundPlayed&&(this.soundPlayed=!0,res.sfx.death.play(),res.sfx.fail.play())}IsHovering(){return this.animationTimer<this.showRetryTime?!1:battle.mousePos.x>=this.retryButton.x&&battle.mousePos.x<=this.retryButton.x+this.retryButton.w&&battle.mousePos.y>=this.retryButton.y&&battle.mousePos.y<=this.retryButton.y+this.retryButton.h?!0:!1}PointerUp(a){this.typeWriter.finished||this.typeWriter.PointerUp(a);
this.animationTimer<this.showRetryTime?this.animationTimer=this.showRetryTime+this.showRetrySpeed:this.IsHovering()&&Restart()}UpdateCursor(){this.IsHovering()?"pointer"!=battle.canvas.style.cursor&&(battle.canvas.style.cursor="pointer"):""!=battle.canvas.style.cursor&&(battle.canvas.style.cursor="")}Render(a,b){a.fillStyle="#000";a.fillRect(0,0,a.canvas.width,a.canvas.height);this.typeWriter.Render(a,b);this.animationTimer>this.showTextTime&&(a.globalAlpha=(this.animationTimer-this.showTextTime)/
this.showTextSpeed,a.font="108px Pangolin",a.fillStyle="#aaa",a.textBaseline="top",a.textAlign="center",a.fillText(loc.Get("hud","game_over"),a.canvas.width/2,200),a.globalAlpha=1);this.animationTimer>this.showRetryTime&&(a.globalAlpha=(this.animationTimer-this.showRetryTime)/this.showRetrySpeed,a.lineWidth=3,this.IsHovering()?a.fillStyle=a.strokeStyle="#0d85f3":a.fillStyle=a.strokeStyle="#fff",a.beginPath(),Utils.RoundedRect(a,this.retryButton.x,this.retryButton.y,this.retryButton.w,this.retryButton.h,
6),a.stroke(),a.closePath(),Utils.MaskSprite(a,battle.tempCtx,res.sprites.buttons,0,100,50,50,this.retryButton.x+10,this.retryButton.y+this.retryButton.h/2-25,50,50,a.fillStyle),a.font="32px Pangolin",a.textBaseline="middle",a.textAlign="left",a.fillText(loc.Get("hud","restart"),this.retryButton.x+70,this.retryButton.y+this.retryButton.h/2+3),a.globalAlpha=1);var c=b=0;this.animationTimer>=this.silentTime&&(b=5*(Math.random()-.5),c=5*(Math.random()-.5));if(this.animationTimer<this.shakeTime){var d=
0;battle.HasEffect(EFFECT_DRAWING_TIME)&&(d=33);a.drawImage(res.sprites.soul,0,d,32,32,this.soulPos.x+b,this.soulPos.y+c,32,32)}else b=(this.animationTimer-this.shakeTime)/this.breakSpeed,this.animationTimer-this.shakeTime>=this.breakDelay?(c=(this.animationTimer-this.shakeTime-this.breakDelay)/this.breakSpeed,d=Utils.CurvePos({x:this.soulPos.x+16,y:this.soulPos.y+14-10},{x:this.soulPos.x-64,y:a.canvas.height},150,c),a.save(),a.translate(d.x,d.y),a.rotate(Math.PI*c*2.5),a.drawImage(res.sprites.soulbreak,
0,0,32,28,-16,-14,32,28),a.restore(),d=Utils.CurvePos({x:this.soulPos.x+16,y:this.soulPos.y+10+20},{x:this.soulPos.x+100,y:a.canvas.height},120,c),a.save(),a.translate(d.x,d.y),a.rotate(-Math.PI*c*3),a.drawImage(res.sprites.soulbreak,0,29,32,20,-16,-10,32,20),a.restore()):(a.drawImage(res.sprites.soulbreak,0,0,32,28,this.soulPos.x,this.soulPos.y-10,32,28),a.drawImage(res.sprites.soulbreak,0,29,32,20,this.soulPos.x,this.soulPos.y+20,32,20)),c=Utils.CurvePos({x:this.soulPos.x+30,y:this.soulPos.y},{x:this.soulPos.x+
130,y:a.canvas.height},200,b),a.save(),a.translate(c.x,c.y),a.rotate(Math.PI*b*2),a.drawImage(res.sprites.soulbreak,0,50,9,12,-4.5,-6,9,12),a.restore(),c=Utils.CurvePos({x:this.soulPos.x+20,y:this.soulPos.y},{x:this.soulPos.x-130,y:a.canvas.height},300,b),a.save(),a.translate(c.x,c.y),a.rotate(-Math.PI*b*1.5),a.drawImage(res.sprites.soulbreak,10,51,12,13,-6,-7.5,12,13),a.restore(),c=Utils.CurvePos({x:this.soulPos.x+20,y:this.soulPos.y},{x:this.soulPos.x+20,y:a.canvas.height},150,b),a.save(),a.translate(c.x,
c.y),a.rotate(Math.PI*b),a.drawImage(res.sprites.soulbreak,22,54,8,8,-4,-4,8,8),a.restore()}}
class IntroMode extends BattleMode{constructor(){super(INTRO);this.shownFrame=this.frame=0;this.frames=res.sheets.story.GetTagFrames("story");this.steal=res.sheets.story.GetTagFrames("steal");this.typeWriter=new TypeWriter(null,!1);this.typeWriter.onLineEnd=this.NextFrame.bind(this);this.typeWriter.autoSkipTime=100;this.fadeTime=24;this.fadeTimer=0;this.triggeredSkip=!1;this.stealTime=85;this.blackTime=40;this.stealTimer=0;this.soundPlayed=this.stealing=!1}Start(){res.sfx.intro.play();this.typeWriter.Start();
this.typeWriter.textBounds.x1=390;this.typeWriter.textBounds.y1=480;this.typeWriter.textBounds.x2=battle.canvas.width-300;this.typeWriter.textBounds.y2=battle.canvas.height-100;this.typeWriter.SetText(loc.Dial("game","intro"));this.triggeredSkip=!1;this.skipButton={x:battle.canvas.width/2-140,y:battle.canvas.height-100,w:280,h:70};this.soundPlayed=!1}NextFrame(){this.frame=this.typeWriter.index;this.typeWriter.voice=9==this.frame||10==this.frame?res.sfx.duck:res.sfx.check;this.frame==this.frames.length-
1?this.stealing||(this.fadeTimer=0,this.stealing=!0,this.stealTimer=this.stealTime,res.sfx.intro.pause(),battle.soul.x=615,battle.soul.y=260,this.UpdateCursor()):this.fadeTimer=this.fadeTime}Finish(){res.sfx.intro.pause();battle.Begin()}IsHovering(){return this.triggeredSkip?battle.mousePos.x>=this.skipButton.x&&battle.mousePos.x<=this.skipButton.x+this.skipButton.w&&battle.mousePos.y>=this.skipButton.y&&battle.mousePos.y<=this.skipButton.y+this.skipButton.h?!0:!1:!1}PointerUp(a){this.IsHovering()?
(Utils.RandomArray([res.sfx.click1,res.sfx.click2,res.sfx.click3]).play(),this.Finish()):(this.triggeredSkip||(this.triggeredSkip=!0),this.typeWriter.PointerUp(a))}UpdateCursor(){this.stealing?"none"!=battle.canvas.style.cursor&&(battle.canvas.style.cursor="none"):this.IsHovering()?"pointer"!=battle.canvas.style.cursor&&(battle.canvas.style.cursor="pointer"):""!=battle.canvas.style.cursor&&(battle.canvas.style.cursor="")}GameLoop(a){0<this.fadeTimer?this.fadeTimer-=1*a:this.typeWriter.GameLoop(a);
this.stealing&&(0<this.stealTimer?(this.stealTimer-=1*a,this.stealTimer<=this.blackTime?(this.soundPlayed||(res.sfx.vroom.play(),this.soundPlayed=!0),battle.MoveSoul(),battle.soul.GameLoop(a)):1>this.stealTimer%5&&res.sfx.chop.play()):this.Finish())}Render(a,b){var c=Utils.Clamp(this.fadeTimer/this.fadeTime,0,1);.5>=c&&(this.shownFrame=this.frame);this.stealing&&this.stealTimer>this.blackTime&&(this.shownFrame=Utils.GetAnimationFrame(b,100,this.steal));a.strokeStyle="#000";a.lineWidth=3;a.beginPath();
Utils.RoundedRect(a,320,80,640,380,6);a.save();a.clip();res.sheets.story.Draw(a,"story",this.frames[this.shownFrame],320,80);a.restore();a.stroke();a.globalAlpha=.5>=c?c/.5:1-(c-.5)/.5;a.fillStyle="#000";a.fill();a.globalAlpha=1;a.closePath();this.typeWriter.Render(a,b);this.triggeredSkip&&(a.lineWidth=3,c=this.IsHovering()?a.strokeStyle="#0d85f3":a.strokeStyle="#000",a.fillStyle="#fff",a.beginPath(),Utils.RoundedRect(a,this.skipButton.x,this.skipButton.y,this.skipButton.w,this.skipButton.h,6),a.fill(),
a.stroke(),a.closePath(),a.fillStyle=c,Utils.MaskSprite(a,battle.tempCtx,res.sprites.buttons,50,50,50,50,this.skipButton.x+10,this.skipButton.y+this.skipButton.h/2-25,50,50,a.fillStyle),a.font="32px Pangolin",a.textBaseline="middle",a.textAlign="left",a.fillText(loc.Get("hud","skip"),this.skipButton.x+70,this.skipButton.y+this.skipButton.h/2+3));this.stealing&&this.stealTimer<=this.blackTime&&(a.fillStyle="#000",a.fillRect(0,0,a.canvas.width,a.canvas.height),battle.soul.Render(a,b))}}
class CreditsMode extends BattleMode{constructor(){super(CREDITS)}Start(){this.textBounds={x1:100,y1:75,x2:640,y2:550};battle.ctx.font="16px Pangolin";this.text=Utils.SliceText(battle.ctx,loc.Dial("game","credits"),this.textBounds)}Render(a,b){a.textBaseline="top";a.textAlign="left";let c=this.text[0].split(/~|\n/),d=!1,e=!1,f=0;for(let k=0;k<c.length;k++){let m=c[k],l=this.textBounds.x1,n=this.textBounds.y1+f;for(let p=0;p<m.length;p++){let r=m.charAt(p);if("^"==r)d=!d;else{var g=0,h=0;d?(a.font=
"36px Pangolin",a.fillStyle=battle.theme.Outline(),g=10,h=5):(a.font="24px Pangolin",a.fillStyle="#666");"%"==r?e=!e:(e&&(g+=32*Math.cos(b/200+(k+p)/2)/12,h+=32*-Math.sin(b/200+(k+p)/2)/12),a.fillText(r,l+g,n+h),l+=a.measureText(r).width)}}g=battle.ctx.measureText(m);f+=g.fontBoundingBoxAscent+g.fontBoundingBoxDescent}if(1==battle.ending||2==battle.ending)a.strokeStyle="#000",a.lineWidth=3,a.beginPath(),Utils.RoundedRect(a,730,50,450,600,6),a.save(),a.clip(),a.drawImage(res.sprites.ending,730,50),
a.restore(),a.stroke(),a.closePath(),a.beginPath(),Utils.RoundedRect(a,846,175,230,150,12),a.save(),a.clip(),2==battle.ending?(a.fillStyle="#e6e9ff",a.fillRect(836,170,250,165),res.sheets.promo1.Draw(a,"promo1",Utils.GetAnimationFrame(b,200,res.sheets.promo1.GetTagFrames("idle")),836,170)):res.sheets.promo2.Draw(a,"promo2",Utils.GetAnimationFrame(b,200,res.sheets.promo2.GetTagFrames("idle")),836,170),a.restore(),a.closePath()}};class TypeWriter{constructor(a=null,b=!0,c=res.sfx.check){this.parent=a;this.voice=c;this.text=["*\u041f\u043e\u0440\u0430 \u043f\u0440\u043e\u0441\u043d\u0443\u0442\u044c\u0441\u044f \u0438 \u043f\u043e\u0447\u0443\u0432\u0441\u0442\u0432\u043e\u0432\u0430\u0442\u044c \u0437\u0430\u043f\u0430\u0445 @1\u0411\u041e\u041b\u0418@."];this.actions=[];this.textSize=36;this.textBounds={};this.textTriggers=[];this.currentAction=null;this.timer=this.value=this.index=0;this.showClickToContinueTip=b;this.clickedAtLeastOnce=
!1;this.stuckTimer=this.stuckTime=100;this.autoSkipTimer=this.autoSkipTime=300;this.finished=this.lineFinished=!0;this.speed=3;this.speedPunctuation=10;this.speedNextLine=50;this.onLineEnd=null}Start(){this.textSize=36;this.textBounds={x1:battle.defaultBounds.x1+25,x2:battle.defaultBounds.x2-25,y1:battle.defaultBounds.y1+25,y2:battle.defaultBounds.y2-15}}SetText(a){this.text=[...a];this.actions=[];this.textTriggers=Array(this.text.length);this.currentAction=null;for(var b in this.text){a=this.text[b];
let c=/&\d+/.exec(a);c&&(this.textTriggers[b]=1*c[0].split("&")[1]);this.text[b]=a.replaceAll(/&\d+/g,"")}this.expressions=Array(this.text.length);for(let c in this.text)b=this.text[c],(a=/#[\dA-Za-z]/.exec(b))&&(this.expressions[c]=a[0].split("#")[1]),this.text[c]=b.replaceAll(/#[\dA-Za-z]/g,"");battle.ctx.font=`${this.textSize}px Pangolin`;this.text=Utils.SliceText(battle.ctx,this.text,this.textBounds);this.SetIndex(0);this.timer=this.value=0;this.stuckTimer=this.stuckTime;this.finished=this.lineFinished=
!1}GetText(){return this.text[this.index].slice(0,this.value)}SetActions(a){this.actions=[...a]}PointerUp(a){null!=this.currentAction?this.currentAction.PointerUp(a):this.lineFinished?(this.clickedAtLeastOnce=!0,this.NextLine()):(this.value=this.text[this.index].length,this.FinishLine())}FinishLine(){this.lineFinished=!0;let a=this.textTriggers[this.index];null!=a&&null!=this.actions[a]&&(this.currentAction=this.actions[a](),this.currentAction.Start())}NextLine(){this.lineFinished&&this.index+1<this.text.length?
this.SetIndex(this.index+1):this.finished=!0;if(null!=this.onLineEnd)this.onLineEnd()}SetIndex(a){this.index=a;this.lineFinished=!1;this.stuckTimer=this.stuckTime;this.autoSkipTimer=this.autoSkipTime;this.timer=this.value=0}Render(a,b){null!=this.currentAction&&this.currentAction.Render(a,b);this.DrawText(a,b);0>=this.stuckTimer&&!this.clickedAtLeastOnce&&this.showClickToContinueTip&&(a.font="24px Pangolin",a.fillStyle="#666",a.textBaseline="bottom",a.textAlign="right",a.fillText(loc.Get("hud","click_to_continue"),
this.textBounds.x2,this.textBounds.y2))}GameLoop(a){if(null!=this.currentAction)if(this.currentAction.GameLoop(a),this.currentAction.finished)this.NextLine(),this.currentAction=null;else return;if(this.finished||this.lineFinished)0<this.stuckTimer&&(this.stuckTimer-=1*a),0<this.autoSkipTimer&&(this.autoSkipTimer-=1*a,0>=this.autoSkipTimer&&this.NextLine());else if(this.timer-=1*a,0>=this.timer)if(this.value>=this.text[this.index].length)this.FinishLine();else{a=this.text[this.index].charAt(this.value);
var b=!1;switch(a){case "@":b=!0;this.timer=0;break;case "^":case "$":this.timer=0;break;case ".":this.Speak(a);case ",":case "?":case "!":case "\u2014":case "*":case "(":case ")":this.timer=this.speedPunctuation;break;case "%":this.timer=this.speedNextLine;break;default:this.timer=this.speed,this.Speak(a)}this.value++;b&&this.value++}}static IsPronounced(a){switch(a){case "@":case "^":case "$":case ",":case "?":case "!":case "\u2014":case "*":case "(":case ")":case " ":case "\n":case "~":return!1}return!0}CanPronounce(){return this.value>=
this.text[this.index].length?!1:TypeWriter.IsPronounced(this.text[this.index].charAt(this.value))}Speak(a){TypeWriter.IsPronounced(a)&&this.voice.play()}DrawText(a,b){let c=battle.theme.Outline();a.font=`${this.textSize}px Pangolin`;a.fillStyle=c;a.textBaseline="top";a.textAlign="left";var d=this.GetText();let e=d.split(/~|\n/).filter(n=>n);d=a.measureText(d);d=d.fontBoundingBoxAscent+d.fontBoundingBoxDescent;let f=!1,g=!1,h=!1,k=!1;for(let n=0;n<e.length;n++){let p=e[n],r=this.textBounds.x1,u=this.textBounds.y1+
d*n;for(let t=0;t<p.length;t++){let q=p.charAt(t);if("%"!=q)if("@"==q)f?(a.fillStyle=c,f=!1):g=f=!0;else{if(g&&(g=!1,!isNaN(1*q)&&0<=1*q&&1*q<TEXT_COLORS.length)){a.fillStyle=TEXT_COLORS[1*q];continue}if("^"==q)h=!h;else if("$"==q)k=!k;else{var m=0,l=0;h&&(m=(Math.random()-.5)*this.textSize/9,l=(Math.random()-.5)*this.textSize/9);k&&(m=Math.cos(b/150+(n+t)/2)*this.textSize/12,l=-Math.sin(b/150+(n+t)/2)*this.textSize/12);a.fillText(q,r+m,u+l);r+=a.measureText(q).width}}}}}}
class SpeechBubble extends TypeWriter{constructor(a=null,b=res.sfx.check,c=!1){super(a,!0,b);this.mirrored=c}Start(){this.textSize=24;null!=this.parent&&(this.textBounds={x1:this.parent.x+this.parent.w+15+10,x2:battle.defaultBounds.x2-15,y1:this.parent.y+55+10,y2:0})}NextLine(){null!=this.parent&&this.parent.ResetExpression();super.NextLine()}SetIndex(a){super.SetIndex(a);a=this.expressions[this.index];null!=this.parent&&(null!=a?this.parent.SetExpression(a):this.parent.ResetExpression())}Render(a,
b){if(null!=this.currentAction)this.currentAction.Render(a,b);else if(0!=this.text[this.index].length){null!=this.parent&&(this.textBounds={x1:this.parent.x+this.parent.w-55+10,y1:this.parent.y+85+10,y2:0},this.textBounds.x2=this.textBounds.x1+250);var c=this.textBounds.x1-10,d=this.textBounds.y1-14,e=this.textBounds.x2-c+15,f=Utils.TextHeight(a,this.text[this.index],this.textSize)+20;a.lineWidth=3;a.fillStyle=battle.theme.Background();a.strokeStyle=battle.theme.Outline();this.mirrored?(a.beginPath(),
a.moveTo(c+e+20,d+25),a.lineTo(c+e,d+25-10),a.arcTo(c+e,d,c,d,6),a.arcTo(c,d,c,d+f,6),a.arcTo(c,d+f,c+e,d+f,6),a.arcTo(c+e,d+f,c+e,d,6),a.lineTo(c+e,d+10+25),a.lineTo(c+e+20,d+25)):(a.beginPath(),a.moveTo(c-20,d+25),a.lineTo(c,d+25-10),a.arcTo(c,d,c+e,d,6),a.arcTo(c+e,d,c+e,d+f,6),a.arcTo(c+e,d+f,c,d+f,6),a.arcTo(c,d+f,c,d,6),a.lineTo(c,d+10+25),a.lineTo(c-20,d+25));a.fill();a.stroke();a.closePath();this.DrawText(a,b);0>=this.stuckTimer&&!this.clickedAtLeastOnce&&this.showClickToContinueTip&&(a.font=
"16px Pangolin",a.fillStyle="#666",a.fillText(loc.Get("hud","click_to_continue"),c,d+f+10))}}}
class BattleUI{constructor(){this.clickTarget=null;this.buttonsPrepared=!1}Start(){if(!this.buttonsPrepared){this.buttons=[{name:loc.Get("hud","back"),modes:[IDLE],index:{x:1,y:2},action:battle.Back.bind(battle),back:!0},{name:loc.Get("hud","attack"),modes:[OWN_ATTACK],index:{x:0,y:0},action:battle.OwnAttack.bind(battle)},{name:loc.Get("hud","act"),modes:[ACT,DRAW],index:{x:1,y:0},action:battle.Act.bind(battle)},{name:loc.Get("hud","items"),modes:[ITEMS],index:{x:0,y:1},action:battle.Items.bind(battle)}];
let a=(battle.defaultBounds.x2-battle.defaultBounds.x1-20*(this.buttons.length-2))/(this.buttons.length-1);for(let b in this.buttons){let c=this.buttons[b];c.back?(c.x=battle.defaultBounds.x1-70-20,c.w=70):(c.x=battle.defaultBounds.x1+(b-1)*(a+20),c.w=a)}this.buttonsPrepared=!0}}TargetButton(){if(battle.mode.id!=IDLE&&(battle.mode.locked||battle.mode.drawingLocked)||battle.mousePos.y<battle.defaultBounds.y2+70||battle.mousePos.y>battle.defaultBounds.y2+70+70)return null;for(let a in this.buttons)if(battle.mousePos.x>=
this.buttons[a].x&&battle.mousePos.x<=this.buttons[a].x+this.buttons[a].w)return this.buttons[a];return null}PointerDown(a){this.clickTarget=this.TargetButton()}PointerUp(a){(a=this.TargetButton())&&a==this.clickTarget&&(Utils.RandomArray([res.sfx.click1,res.sfx.click2,res.sfx.click3]).play(),a.action());this.clickTarget=null}Render(a,b){a.lineWidth=3;b=this.TargetButton();a.font="36px Pangolin";a.textBaseline="middle";a.textAlign="left";for(let c in this.buttons){let d=this.buttons[c];d.back&&(battle.mode.locked||
battle.mode.drawingLocked||battle.mode.id==IDLE)||(b==d||-1!=d.modes.indexOf(battle.mode.id)?a.fillStyle=a.strokeStyle="#0d85f3":a.fillStyle=battle.mode.id==IDLE||!battle.mode.locked&&!battle.mode.drawingLocked?a.strokeStyle=battle.theme.Outline():a.strokeStyle="#aaa",a.fillStyle=battle.theme.Background(),a.beginPath(),Utils.RoundedRect(a,d.x,battle.defaultBounds.y2+70,d.w,70,6),a.fill(),a.stroke(),a.closePath(),a.fillStyle=a.strokeStyle,Utils.MaskSprite(a,battle.tempCtx,res.sprites.buttons,50*d.index.x,
50*d.index.y,50,50,d.x+10,battle.defaultBounds.y2+70+35-25,50,50,a.fillStyle),d.back||a.fillText(d.name,d.x+70,battle.defaultBounds.y2+70+35+4))}}}
class BattleTheme{constructor(){this.distance=125;this.rowOffset=50;this.speed=.5;this.scroll={x:0,y:0};this.patterns=[];this.backgroundCanvas=document.createElement("canvas");this.backgroundCtx=this.backgroundCanvas.getContext("2d");this.backgroundCtx.imageSmoothingEnabled=!1;this.backgroundColor={r:255,g:255,b:255};this.outlineColor={r:0,g:0,b:0};this.serious=!1}Background(){return`rgba(${this.backgroundColor.r}, ${this.backgroundColor.g}, ${this.backgroundColor.b})`}Outline(){return`rgba(${this.outlineColor.r}, ${this.outlineColor.g}, ${this.outlineColor.b})`}Swap(a,
b,c){this.backgroundColor={r:a.r,g:a.g,b:a.b};this.outlineColor={r:b.r,g:b.g,b:b.b};this.serious=c}Start(){this.rows=6;this.columns=4;var a=res.sheets.patterns.parts.pattern.length;let b=0;for(let d=0;d<this.rows*this.columns;d++){let e={};e.id=b%a;b++;e.x=d%this.rows*this.distance-~~(d/this.rows)*this.rowOffset;e.y=~~(d/this.rows)*this.distance;0==e.x&&0<e.y&&(b=Utils.RandomRound(b%a,a));e.rotation=Utils.Random(-Math.PI/12,Math.PI/12);this.patterns.push(e)}this.backgroundCanvas.width=this.rows*this.distance;
this.backgroundCanvas.height=this.columns*this.distance;this.backgroundCtx.clearRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);this.backgroundCtx.globalAlpha=.25;this.backgroundCtx.translate(this.distance/4,this.distance/4);for(var c in this.patterns)a=this.patterns[c],this.DrawPattern(this.backgroundCtx,a,a.x,a.y);for(c=0;c<this.patterns.length;c+=this.rows)a=this.patterns[c],this.DrawPattern(this.backgroundCtx,a,a.x+this.rows*this.distance,a.y),c+1<this.patterns.length&&(a=this.patterns[c+
1],this.DrawPattern(this.backgroundCtx,a,a.x+this.rows*this.distance,a.y));for(c=0;c<this.rows;c++)a=this.patterns[c],this.DrawPattern(this.backgroundCtx,a,a.x,a.y+this.columns*this.distance);c=this.patterns[0];this.DrawPattern(this.backgroundCtx,c,c.x+this.rows*this.distance,c.y+this.columns*this.distance);this.pattern=battle.ctx.createPattern(this.backgroundCanvas,"repeat");c=battle.canvas.width/2;a=battle.canvas.height/2-300;this.gradient=battle.ctx.createRadialGradient(c,a,battle.canvas.width/
4,c,a,battle.canvas.width/2);this.gradient.addColorStop(0,"rgba(237, 238, 240, 0)");this.gradient.addColorStop(1,"rgba(237, 238, 240, .8)")}Render(a,b){this.serious?a.fillStyle=this.Background():(a.fillStyle="#edeef0",a.fillRect(0,0,a.canvas.width,a.canvas.height),settings.movingBG&&(this.scroll.x-=this.speed*b,this.scroll.x<=-this.backgroundCanvas.width&&(this.scroll.x=0),this.scroll.y+=this.speed*b,this.scroll.y>=this.backgroundCanvas.height&&(this.scroll.y=0)),a.save(),a.translate(this.scroll.x,
this.scroll.y),a.fillStyle=this.pattern,a.fillRect(0,-a.canvas.height,2*a.canvas.width,2*a.canvas.height),a.restore(),a.fillStyle=this.gradient);a.fillRect(0,0,a.canvas.width,a.canvas.height)}DrawPattern(a,b,c,d){a.save();a.translate(c,d);a.rotate(b.rotation);res.sheets.patterns.Draw(a,"pattern",b.id,0,0,-1,-1,!0,!0);a.restore()}}
class EnemiesContainer{constructor(){this.enemiesCanvas=document.createElement("canvas");this.enemiesCtx=this.enemiesCanvas.getContext("2d");this.enemiesCtx.imageSmoothingEnabled=!1;this.alphaTime=10;this.alphaTimer=0;this.alphaBack=!0;this.state=STATE_NORMAL}Start(){this.enemiesCanvas.width=battle.canvas.width;this.enemiesCanvas.height=battle.canvas.height;this.AlignEnemies()}AlignEnemies(){var a=0;for(var b in battle.enemies)a+=battle.enemies[b].sprite.w,b+1<battle.enemies.length&&(a+=50);a=battle.defaultBounds.x1+
(battle.defaultBounds.x2-battle.defaultBounds.x1-a)/2;for(let c in battle.enemies)b=battle.enemies[c],b.sprite.x=a,a+=b.sprite.w+50}GameLoop(a){0<this.alphaTimer&&(this.alphaTimer-=1*a,0>this.alphaTimer&&(this.alphaTimer=0));for(let b in battle.enemies)battle.enemies[b].sprite.GameLoop(a)}SetState(a){let b=this.state;this.state=a;this.state==STATE_ATTACKING?(this.alphaBack=!1,this.alphaTimer=this.alphaTime):b==STATE_ATTACKING&&(this.alphaBack=!0,this.alphaTimer=this.alphaTime);this.state==STATE_BYE&&
(this.alphaTimer=0)}Render(a,b){this.enemiesCtx.clearRect(0,0,this.enemiesCanvas.width,this.enemiesCanvas.height);for(let c in battle.enemies)battle.enemies[c].sprite.Render(this.enemiesCtx,b);0<=this.alphaTimer&&(this.enemiesCtx.globalAlpha=this.alphaBack?.5-(this.alphaTime-this.alphaTimer)/this.alphaTime/2:.5*(this.alphaTime-this.alphaTimer)/this.alphaTime);this.enemiesCtx.globalCompositeOperation="source-atop";this.enemiesCtx.fillStyle="#fff";this.enemiesCtx.fillRect(0,0,this.enemiesCanvas.width,
this.enemiesCanvas.height);this.enemiesCtx.globalCompositeOperation="source-over";this.enemiesCtx.globalAlpha=1;a.drawImage(this.enemiesCanvas,0,0)}}
class Battle{constructor(){this.canvas=document.querySelector("#battle");this.ctx=this.canvas.getContext("2d");this.ctx.imageSmoothingEnabled=!1;this.ctx.resetTransform();this.ctx.translate(.5,.5);this.ctx.lineCap=this.ctx.lineJoin="round";this.tempCanvas=document.createElement("canvas");this.tempCtx=this.tempCanvas.getContext("2d");this.tempCtx.imageSmoothingEnabled=!1;this.modes=[new IdleMode,new PreAttackMode,new AttackMode,new PostAttackMode,new OwnAttackMode,new ActMode,new ItemsMode,new DrawMode,
new DealMode,new GameOverMode,new IntroMode,new CreditsMode];this.pointerDownBind=this.PointerDown.bind(this);this.contextMenuBind=a=>a.preventDefault();this.pointerMoveBind=this.PointerMove.bind(this);this.pointerUpBind=this.PointerUp.bind(this);this.canvas.addEventListener("pointerdown",this.pointerDownBind);this.canvas.addEventListener("contextmenu",this.contextMenuBind);window.addEventListener("pointermove",this.pointerMoveBind);window.addEventListener("pointerup",this.pointerUpBind);this.defaultBounds=
{x1:200,y1:340,x2:1080,y2:550,a:1};this.bounds={...this.defaultBounds};this.targetBounds={...this.bounds};this.fakeBounds=null;this.boundsReady=!0;this.slowBounds=!1;this.ui=new BattleUI;this.blanked=!1;this.blankedTimer=0;this.blankedTime=15;this.blankedReverse=!1;this.enemies=[new PromoDuck];for(let a in this.enemies)this.enemies[a].CreateSprite(0,0);this.lastActionResult=null;this.mousePos={x:this.defaultBounds.x1,y:this.defaultBounds.y1};this.soul=new Soul(this.mousePos.x,this.mousePos.y);this.hp=
this.maxHP=20;this.tp=0;this.effects=[];this.inventory=[new Sharpener,new RubberBand,new GhostCandy];this.ownAttacks={"":{id:"",damage:0,sheet:res.sheets.triangle},circle:{id:"circle",damage:25,sheet:res.sheets.circle,sfx:[res.sfx.circle1,res.sfx.circle2]},triangle:{id:"triangle",damage:50,sheet:res.sheets.triangle,sfx:[res.sfx.triangle1,res.sfx.triangle2]},star:{id:"star",damage:75,sheet:res.sheets.star,sfx:[res.sfx.star1,res.sfx.star2]}};this.ownAttackIndex=1;this.attack=null;this.attackCounter=
0;this.finished=!1;this.projectiles=[];this.theme=new BattleTheme;this.enemiesContainer=new EnemiesContainer;this.lastRender=0;this.render=requestAnimationFrame(this.Render.bind(this));this.ending=-1}SetEnding(a){this.ending=a}Destroy(){cancelAnimationFrame(this.render);this.canvas.removeEventListener("pointerdown",this.pointerDownBind);this.canvas.removeEventListener("contextmenu",this.contextMenuBind);window.removeEventListener("pointermove",this.pointerMoveBind);window.removeEventListener("pointerup",
this.pointerUpBind)}Start(a=!1){this.theme.Start();this.enemiesContainer.Start();this.ui.Start();for(let b in this.enemies)this.enemies[b].Start();a?this.Begin():this.Intro()}Begin(){res.sfx.bgm.play();this.SetMode(IDLE)}SetBounds(a,b=!1,c=!1){this.slowBounds=b;this.targetBounds={...a};this.boundsReady=!1;if(Utils.BoundsEqual(this.bounds,this.targetBounds)||c)this.slowBounds=!1,this.bounds={...this.targetBounds},this.boundsReady=!0}ResetBounds(a=!1,b=!1){this.SetBounds({...this.defaultBounds},a,b);
this.ResetFakeBounds()}SetFakeBounds(a){this.fakeBounds={x1:this.targetBounds.x1+a.x1,x2:this.targetBounds.x2+a.x2,y1:this.targetBounds.y1+a.y1,y2:this.targetBounds.y2+a.y2}}ResetFakeBounds(){this.fakeBounds=null}AddEffect(a,b){let c=this.GetEffect(a);null!=c?c.turns+=b:this.effects.push({id:a,turns:b})}GetEffect(a){let b=this.effects.filter(c=>c.id==a);return 0<b.length?b[0]:null}HasEffect(a){return null!=this.GetEffect(a)}OnTurnEnd(){for(let a=this.effects.length-1;0<=a;a--){let b=this.effects[a];
b.id!=EFFECT_DRAWING_TIME&&this.DecreaseEffectTurns(b.id)}}DecreaseEffectTurns(a){a=this.GetEffect(a);null!=a&&(a.turns--,0>=a.turns&&(this.effects.splice(this.effects.indexOf(a),1),res.sfx.effectEnd.play()))}Blank(a){this.blanked=!0;this.blankedTimer=this.blankedTime;this.blankedReverse=a}Render(a){var b=(a-this.lastRender)/16.67;1<b&&(b=1);this.lastRender=a;this.GameLoop(b);this.render=requestAnimationFrame(this.Render.bind(this));this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.mode.id==
GAME_OVER||this.mode.id==INTRO||this.mode.id==CREDITS)this.mode.id!=GAME_OVER&&this.theme.Render(this.ctx,b),this.mode.Render(this.ctx,a);else{this.theme.Render(this.ctx,b);this.enemiesContainer.Render(this.ctx,a);for(var c in this.enemies)b=this.enemies[c],b.sprite.speaking&&b.sprite.speechBubble.Render(this.ctx,a);c=this.defaultBounds.x1+(this.defaultBounds.x2-this.defaultBounds.x1)/2-100;b=this.defaultBounds.y2+10+9;this.ctx.save();this.ctx.beginPath();Utils.RoundedRect(this.ctx,c,b,200,32,6);
this.ctx.clip();this.ctx.fillStyle=this.theme.Outline();this.ctx.fillRect(c,b,200,32);this.ctx.fillStyle="#0d85f3";this.ctx.fillRect(c,b,200*this.hp/this.maxHP,32);this.ctx.restore();this.ctx.lineWidth=3;this.ctx.strokeStyle=this.theme.Outline();this.ctx.stroke();this.ctx.closePath();this.ctx.font="24px Pangolin";this.ctx.fillStyle=this.theme.Background();this.ctx.textBaseline="middle";this.ctx.textAlign="center";this.ctx.fillText(`${this.hp} / ${this.maxHP}`,c+100,b+1+16);this.ctx.fillStyle=this.theme.Outline();
Utils.MaskSprite(this.ctx,this.tempCtx,res.sprites.effects,0,0,24,24,c-24-6,b+4,24,24,this.ctx.fillStyle);this.ctx.textAlign="left";for(var d in this.effects){let e=this.effects[d];Utils.MaskSprite(this.ctx,this.tempCtx,res.sprites.effects,24*e.id,0,24,24,c+200+12+55*d,b+4,24,24,this.ctx.fillStyle);this.ctx.fillText(`${e.turns}`,c+200+12+55*d+24+6,b+1+16)}this.ui.Render(this.ctx,a);this.blanked&&(d=this.blankedTimer/this.blankedTime,this.blankedReverse&&(d=1-d),this.ctx.globalAlpha=d,this.ctx.fillStyle=
"#aaa",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.globalAlpha=1);this.ctx.lineCap="round";this.ctx.lineJoin="round";this.ctx.lineWidth=3;this.ctx.strokeStyle=this.theme.Outline();this.ctx.fillStyle=this.theme.Background();this.ctx.beginPath();Utils.RoundedRect(this.ctx,this.bounds.x1,this.bounds.y1,this.bounds.x2-this.bounds.x1,this.bounds.y2-this.bounds.y1,6);this.ctx.globalAlpha=this.bounds.a;this.ctx.fill();this.ctx.globalAlpha=1;this.ctx.stroke();this.ctx.closePath();this.mode.Render(this.ctx,
a);this.soul.Render(this.ctx,a);this.projectiles.sort((e,f)=>e.onTop!=f.onTop?e.onTop-f.onTop:e.y-f.y);for(let e in this.projectiles)this.projectiles[e].Render(this.ctx,a);null!=this.attack&&this.attack.Render(this.ctx,a)}}GameLoop(a){if(this.mode.id==GAME_OVER||this.mode.id==INTRO||this.mode.id==CREDITS)this.mode.GameLoop(a);else{this.MoveSoul();if(!this.boundsReady){var b=(this.slowBounds?.15:.3)*a;this.bounds.x1=Utils.Lerp(this.bounds.x1,this.targetBounds.x1,b);this.bounds.y1=Utils.Lerp(this.bounds.y1,
this.targetBounds.y1,b);this.bounds.x2=Utils.Lerp(this.bounds.x2,this.targetBounds.x2,b);this.bounds.y2=Utils.Lerp(this.bounds.y2,this.targetBounds.y2,b);this.bounds.a=Utils.Lerp(this.bounds.a,this.targetBounds.a,b);Utils.BoundsEqual(this.bounds,this.targetBounds)&&(this.slowBounds=!1,this.bounds={...this.targetBounds},this.boundsReady=!0)}this.enemiesContainer.GameLoop(a);this.mode.GameLoop(a);this.blanked&&0<this.blankedTimer&&(this.blankedTimer-=1*a);0>=this.blankedTimer&&this.blanked&&!this.blankedReverse&&
(this.blankedReverse=this.blanked=!1);if(null!=this.attack){this.attack.GameLoop(a);for(var c in this.projectiles)this.projectiles[c].GameLoop(a);for(b=this.projectiles.length-1;0<=b;b--)if(c=this.projectiles[b])if(c.toDestroy)this.DestroyProjectileById(b);else if(c.Collision(!1))this.Hurt(c.damage),c.destructible&&(c.toDestroy=!0);else if(c.Collision(!0))this.Graze(c);else if(0>c.x+c.w||0>c.y+c.h||c.x-c.w>this.canvas.width||c.y-c.h>this.canvas.height)c.toDestroy=!0}this.soul.GameLoop(a)}}Back(){this.mode.id!=
GAME_OVER&&this.mode.id!=INTRO&&this.mode.id!=CREDITS&&this.mode.Back&&this.mode.Back()}PreAttack(){null==this.lastActionResult||null==this.lastActionResult.text&&!this.lastActionResult.speech&&null==this.lastActionResult.mode?this.Attack():null!=this.lastActionResult.text||null!=this.lastActionResult.speech?this.SetMode(PRE_ATTACK):null!=this.lastActionResult.mode&&this.SetMode(this.lastActionResult.mode)}Attack(){for(var a in battle.enemies)battle.enemies[a].sprite.ResetExpression();this.SetMode(ATTACK);
this.ResetBounds();a=this.enemies[0].GetAttack();null==a?console.error("\u0410\u0422\u0410\u041a\u0423 \u0414\u0410\u0419 \u041c\u041d\u0415 \u0414\u0423\u0411\u0418\u041d\u0410!!!"):(this.attack=new a.attackClass(this.enemies[0].sprite,a.difficulty),this.attack.Start(),this.lastActionResult=null)}OnAttackEnd(){this.attackCounter++;this.OnTurnEnd();(this.lastActionResult=this.enemies[0].AttackEnd())&&this.lastActionResult.speech?this.SetMode(POST_ATTACK):this.Idle()}OwnAttack(){battle.soul.eaten||
this.finished||(this.mode.id==OWN_ATTACK?this.Idle():this.SetMode(OWN_ATTACK))}OnOwnAttackEnd(){this.ownAttackIndex++;this.ownAttackIndex>=Object.keys(this.ownAttacks).length&&(this.ownAttackIndex=1);let a=!0;for(let b in this.enemies){let c=this.enemies[b];0>=c.hp&&c.alive&&c.Die();c.alive&&(a=!1)}this.PreAttack();a&&(this.finished=!0)}Act(){this.mode.id==ACT?this.Idle():this.SetMode(ACT)}Items(){this.mode.id==ITEMS?this.Idle():this.SetMode(ITEMS)}Idle(){this.SetMode(IDLE);this.ResetBounds();this.lastActionResult=
null}GameOver(){this.SetMode(GAME_OVER)}Credits(){this.SetMode(CREDITS)}Intro(){this.SetMode(INTRO)}SetMode(a){if(null==this.mode||this.mode.id!=GAME_OVER&&this.mode.id!=CREDITS){this.attack=null;this.projectiles=[];this.mode=this.modes[a];this.mode.Start();for(let b in this.enemies){let c=this.enemies[b];c.alive&&c.sprite.SetAnimation(a==ATTACK?STATE_ATTACKING:STATE_NORMAL,0)}this.enemiesContainer.SetState(a==ATTACK?STATE_ATTACKING:STATE_NORMAL)}}AddProjectile(a,b){b.Start();this.projectiles.push(b);
a.spawnedProjectiles.push(b)}DestroyProjectileById(a){var b=this.projectiles.splice(a,1)[0];a=b.parent;b=a.spawnedProjectiles.indexOf(b);-1!=b&&a.spawnedProjectiles.splice(b,1)}DestroyProjectile(a){a=this.projectiles.indexOf(a);-1!=a&&this.DestroyProjectileById(a)}PointerDown(a){this.UpdateMousePos(a);this.mode.PointerDown(a)}PointerUp(a){this.UpdateMousePos(a);this.mode.PointerUp(a)}PointerMove(a){this.UpdateMousePos(a);this.mode.PointerMove(a)}UpdateMousePos(a){this.mousePos=a=Utils.MousePos(a,
this.canvas);this.soul.eaten?""!=this.canvas.style.cursor&&(this.canvas.style.cursor=""):this.mode.id==PRE_ATTACK||this.mode.id==ATTACK||this.mode.drawingLocked?a.x>=this.bounds.x1&&a.x<=this.bounds.x2&&a.y>=this.bounds.y1&&a.y<=this.bounds.y2&&!this.soul.locked&&!this.soul.slowed?this.canvas.style.cursor="none":""!=this.canvas.style.cursor&&(this.canvas.style.cursor=""):this.mode.id==INTRO||this.mode.id==GAME_OVER?this.mode.UpdateCursor():this.mode.id==CREDITS?""!=this.canvas.style.cursor&&(this.canvas.style.cursor=
""):"none"!=this.canvas.style.cursor&&(this.canvas.style.cursor="none")}TeleportSoulToCursor(a){this.UpdateMousePos(a);this.MoveSoul();this.soul.x=this.soul.targetPos.x;this.soul.y=this.soul.targetPos.y}IsCursorInsideBounds(){return battle.mousePos.x<battle.targetBounds.x1||battle.mousePos.x>battle.targetBounds.x2||battle.mousePos.y<battle.targetBounds.y1||battle.mousePos.y>battle.targetBounds.y2?!1:!0}SoulBounds(){return{x1:this.soul.x,y1:this.soul.y,x2:this.soul.x+this.soul.w+this.soul.pivot.x+
this.soul.radius,y2:this.soul.y+this.soul.h+this.soul.pivot.y+this.soul.radius}}MoveSoul(){let a={...this.mousePos};if(this.mode.id==PRE_ATTACK||this.mode.id==ATTACK||this.mode.drawingLocked)a=this.BoundSoulPos(a);this.soul.targetPos=a}BoundSoulPos(a){a={...a};let b=this.targetBounds;null!=this.fakeBounds&&(b=this.fakeBounds);a.x<b.x1&&(a.x=b.x1);a.x>b.x2-this.soul.w-this.soul.pivot.x-this.soul.radius&&(a.x=b.x2-this.soul.w-this.soul.pivot.x-this.soul.radius);a.y<b.y1&&(a.y=b.y1);a.y>b.y2-this.soul.h-
this.soul.pivot.y-this.soul.radius&&(a.y=b.y2-this.soul.h-this.soul.pivot.y-this.soul.radius);return a}Graze(a){}Hurt(a){this.soul.invinsible||(this.soul.Hurt(),this.hp-=a,0>=this.hp&&(this.hp=0,this.GameOver()))}}
class Entity{constructor(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d;this.pivot={x:this.w/2,y:this.h/2};this.rotation=0}Render(a,b){a.save();a.translate(this.x+this.pivot.x,this.y+this.pivot.y);a.rotate(this.rotation);this.Draw(a,b);a.restore()}Draw(a,b){a.fillStyle="green";a.fillRect(-this.pivot.x,-this.pivot.y,this.w,this.h)}}
class Soul extends Entity{constructor(a,b){super(a,b,0,0);this.eaten=this.locked=!1;this.targetPos={x:this.x,y:this.y};this.radius=10;this.grazeRadius=20;this.pivot={x:this.radius,y:this.radius};this.invinsibleTime=50;this.invinsibleTimer=0;this.slowed=this.invinsible=!1;this.maxSpeed=15;this.damping=.5;this.mass=7;this.velocity={x:0,y:0}}Hurt(){battle.HasEffect(EFFECT_INVINSIBILITY)?this.invinsibleTimer=2*this.invinsibleTime:this.invinsibleTimer=this.invinsibleTime;this.invinsible=!0;Utils.RandomArray([res.sfx.hurt,
res.sfx.hurt2]).play()}SetSlowed(a){this.slowed=a;this.velocity.x=0;this.velocity.y=0}GameLoop(a){if(!this.eaten){0<this.invinsibleTimer&&(this.invinsibleTimer-=1*a,0>=this.invinsibleTimer&&(this.invinsible=!1));if(!this.locked)if(this.slowed){var b=(battle.mousePos.y-this.y)/this.mass;this.velocity.x+=(battle.mousePos.x-this.x)/this.mass;this.velocity.y+=b;this.velocity.x=Math.min(Math.max(this.velocity.x,-this.maxSpeed),this.maxSpeed);this.velocity.y=Math.min(Math.max(this.velocity.y,-this.maxSpeed),
this.maxSpeed);a={x:this.x+this.velocity.x*a,y:this.y+this.velocity.y*a};a=battle.BoundSoulPos(a);this.x=a.x;this.y=a.y;this.velocity.x*=this.damping;this.velocity.y*=this.damping}else a*=.5,this.x=Utils.Lerp(this.x,this.targetPos.x,a),this.y=Utils.Lerp(this.y,this.targetPos.y,a);1>=Utils.Distance({x:this.x,y:this.y},this.targetPos)&&(this.x=this.targetPos.x,this.y=this.targetPos.y)}}Render(a,b){this.eaten||(this.invinsible&&4>this.invinsibleTimer%10&&(a.globalAlpha=.5),b=0,battle.HasEffect(EFFECT_DRAWING_TIME)&&
(b=33),a.drawImage(res.sprites.soul,0,b,32,32,this.x,this.y,32,32),a.globalAlpha=1)}};class Enemy{constructor(){this.code="noone";this.name=loc.Get("enemies","noone");this.index={x:0,y:0};this.sprite=null;this.hp=0;this.maxHP=5;this.alive=!0;this.attacks=[TestAttack];this.actions=[{name:loc.Get("actions","check"),index:{x:0,y:0},action:this.Check.bind(this)}]}Dial(a){return loc.Dial(this.code,a)}Start(){this.alive=!0;this.hp=this.maxHP;this.attackCounter=0;this.sprite&&this.sprite.Start()}CreateSprite(a,b){return this.sprite=new EnemySprite(a,b,200,300,this)}GetAttack(){let a=this.attacks[this.attackCounter%
this.attacks.length];this.attackCounter++;return{attackClass:a,difficulty:1}}Die(){this.alive=!1}Idle(){return{text:this.Dial("idle")}}DealDamage(a){this.hp-=a;0>this.hp&&(this.hp=0);return a}Hurt(a){return{}}AttackEnd(){return{}}Drawn(a){return{}}Check(){return{text:this.Dial("check")}}StoryFlow(){return null}}
class EnemySprite extends Entity{constructor(a,b,c,d,e){super(a,b,c,d);this.enemy=e;this.state=STATE_NORMAL;this.animationTime=0;this.expression="0";this.speaking=!1;this.speechBubble=new SpeechBubble(this,res.sfx.duck)}Start(){this.speechBubble.Start()}SetAnimation(a,b){this.state=a;this.animationTime=b}SetExpression(a){this.expression=a}ResetExpression(){this.expression="0"}SetSpeechBubble(a,b){this.speaking=!0;this.speechBubble.SetText(a);this.speechBubble.SetActions(b)}GameLoop(a){this.speaking&&
(this.speechBubble.GameLoop(a),this.speechBubble.finished&&(this.speaking=!1))}Render(a,b){this.Draw(a,b)}Draw(a,b){let c=0;this.state==STATE_HURT&&(c=20*Math.sin(b/20)*this.animationTime);a.fillStyle="red";a.fillRect(this.x+c,this.y,this.w,this.h)}}
class PromoDuckSprite extends EnemySprite{constructor(a,b,c){super(a,b,300,300,c);this.stakeShown=!0;this.stakeShield=0;this.deltaTime=80;this.deltaStickTime=40;this.deltas=[];this.positionLocked=!1;this.vandalismCanvas=document.createElement("canvas");this.vandalismCanvas.width=360;this.vandalismCanvas.height=305;this.vandalismCtx=this.vandalismCanvas.getContext("2d");this.vandalismCtx.imageSmoothingEnabled=!1;this.vandalismCtx.lineCap=this.vandalismCtx.lineJoin="round";this.vandalismCtx.translate(.5,
.5)}ResetExpression(){2==this.enemy.drawAttempt?this.expression="3":super.ResetExpression()}GameLoop(a){super.GameLoop(a);this.positionLocked&&battle.mode.id!=DRAW&&battle.mode.id!=ATTACK&&battle.mode.id!=POST_ATTACK&&battle.boundsReady&&(this.positionLocked=!1);for(let b=this.deltas.length-1;0<=b;b--)this.deltas[b].timer-=1*a,0>=this.deltas[b].timer&&this.deltas.splice(b,1)}AddDelta(a){this.deltas.push({delta:a,timer:this.deltaTime})}Draw(a,b){this.positionLocked||(this.y=battle.bounds.y1-this.h,
0>this.y&&(this.y=0));var c=0<this.enemy.weakened,d=b/150;c&&(d=b/250);var e=~~(3*Math.sin(d)),f=~~(2*Math.sin(d)+e),g=~~(3*Math.cos(d)),h=~~(2.5*Math.sin(d)+e);if(this.state==STATE_DEAD)f=res.sheets.duck.GetTagFrames("death"),g=Math.round(f.length*this.animationTime),g<f.length&&res.sheets.duck.Draw(a,"head",f[g],this.x,this.y);else if(4<=this.enemy.weakened)res.sheets.duck.Draw(a,"shadow",0,this.x,this.y),res.sheets.duck.Draw(a,"body",4,this.x,this.y);else if(this.state==STATE_HURT)f=20*Math.sin(b/
20)*this.animationTime,res.sheets.duck.Draw(a,"body",c?3:1,this.x+f,this.y),res.sheets.duck.Draw(a,"head",c?15:2,this.x+1.5*f,this.y);else if(this.state==STATE_DRAW)g=0,h=~~(5*Math.sin(d)+e),c=~~(5*Math.cos(b/50)),d=~~(5*Math.sin(b/50)+f),res.sheets.duck.Draw(a,"shadow",0,this.x,this.y),res.sheets.duck.Draw(a,"arm_back",0,this.x+0,this.y+f),res.sheets.duck.Draw(a,"feet",1,this.x,this.y),res.sheets.duck.Draw(a,"body",0,this.x+0,this.y+e),res.sheets.duck.Draw(a,"arm_front",1,this.x+c,this.y+d),res.sheets.duck.Draw(a,
"head",8,this.x+g,this.y+h);else if(this.state==STATE_SHIELDING||this.state==STATE_UNSHIELDING)f=this.x,.3>this.animationTime?f=this.x-(this.x-battle.defaultBounds.x1)*this.animationTime/.3:.5>this.animationTime?(f=battle.defaultBounds.x1,this.stakeShield=1):.9>this.animationTime&&(f=battle.defaultBounds.x1-(battle.defaultBounds.x1-this.x)*(this.animationTime-.5)/.4),res.sheets.duck.Draw(a,"shadow",0,f,this.y),res.sheets.duck.Draw(a,"arm_back",2,f,this.y),res.sheets.duck.Draw(a,"feet",2,f,this.y),
res.sheets.duck.Draw(a,"hair",1,f,this.y),res.sheets.duck.Draw(a,"body",2,f,this.y),res.sheets.duck.Draw(a,"arm_front",2,f,this.y),res.sheets.duck.Draw(a,"head",res.sheets.duck.GetTagFrame("expression_5"),f,this.y);else if(this.state==STATE_BYE)c=~~(2*Math.cos(b/25)),d=~~(2*Math.sin(b/25)+f),g=0,res.sheets.duck.Draw(a,"shadow",0,this.x,this.y),res.sheets.duck.Draw(a,"arm_back",0,this.x+0,this.y+f),res.sheets.duck.Draw(a,"feet",0,this.x,this.y),res.sheets.duck.Draw(a,"body",0,this.x+0,this.y+e),1.3<=
this.animationTime?(h-=Utils.CurvePos({x:0,y:0},{x:0,y:0},-5,this.animationTime/1.7).y,res.sheets.duck.Draw(a,"hair",0,this.x+g,this.y+h),res.sheets.duck.Draw(a,"arm_front",0,this.x+0,this.y+f),res.sheets.duck.Draw(a,"head",0,this.x+g,this.y+h)):1<=this.animationTime?(res.sheets.duck.Draw(a,"hair",0,this.x+c,this.y+d),res.sheets.duck.Draw(a,"arm_front",0,this.x+0,this.y+f),res.sheets.duck.Draw(a,"head",0,this.x+c,this.y+d)):.3<=this.animationTime?(res.sheets.duck.Draw(a,"hair",0,this.x+g,this.y+h+
(100<b%200?-3:0)),res.sheets.duck.Draw(a,"arm_front",0,this.x+0,this.y+f),res.sheets.duck.Draw(a,"head",100<b%200?1:0,this.x+g,this.y+h),g=this.x+133,h=this.y+142,f=(this.animationTime-.3)/.25%.8,c=~~((this.animationTime-.3)/.25/.8),0==c%3?(c=Utils.CurvePos({x:g,y:h},{x:g+130,y:a.canvas.height},200,f),d=Utils.CurvePos({x:g,y:h},{x:g-130,y:a.canvas.height},300,f),g=Utils.CurvePos({x:g,y:h},{x:g+20,y:a.canvas.height},150,f)):1==c%3?(c=Utils.CurvePos({x:g,y:h},{x:g+70,y:a.canvas.height},100,f),d=Utils.CurvePos({x:g-
20,y:h},{x:g-50,y:a.canvas.height},200,f),g=Utils.CurvePos({x:g+30,y:h},{x:g-20,y:a.canvas.height},300,f)):(c=Utils.CurvePos({x:g+20,y:h},{x:g,y:a.canvas.height},250,f),d=Utils.CurvePos({x:g-30,y:h},{x:g-80,y:a.canvas.height},150,f),g=Utils.CurvePos({x:g,y:h},{x:g+20,y:a.canvas.height},100,f)),a.save(),a.translate(c.x,c.y),a.rotate(Math.PI*f*2),a.drawImage(res.sprites.soulbreak,0,50,9,12,-4.5,-6,9,12),a.restore(),a.save(),a.translate(d.x,d.y),a.rotate(-Math.PI*f*1.5),a.drawImage(res.sprites.soulbreak,
10,51,12,13,-6,-7.5,12,13),a.restore(),a.save(),a.translate(g.x,g.y),a.rotate(Math.PI*f),a.drawImage(res.sprites.soulbreak,22,54,8,8,-4,-4,8,8),a.restore()):.2<this.animationTime?(res.sheets.duck.Draw(a,"hair",3,this.x+g,this.y+h),res.sheets.duck.Draw(a,"head",res.sheets.duck.GetTagFrame("eat_2"),this.x+g,this.y+h),res.sheets.duck.Draw(a,"arm_more",0,this.x+c,this.y+d)):.1<this.animationTime?(res.sheets.duck.Draw(a,"hair",2,this.x+g,this.y+h),res.sheets.duck.Draw(a,"arm_front",7,this.x+c,this.y+d),
res.sheets.duck.Draw(a,"head",res.sheets.duck.GetTagFrame("eat_1"),this.x+g,this.y+h)):(res.sheets.duck.Draw(a,"arm_front",6,this.x,this.y+f),res.sheets.duck.Draw(a,"head",8,this.x+g,this.y+h));else{d=this.expression;c&&"0"==this.expression&&(d="5");let m=res.sheets.duck.GetTagFrame(`expression_${d}`)||0,l=!1;!this.speechBubble.lineFinished&&this.speechBubble.CanPronounce()&&(l=0<this.speechBubble.value%4,m+=l?1:0);var k=d=0;switch(this.expression){case "0":case "4":case "C":case "D":l&&(k=-3);break;
case "9":l&&(d=2,k=-2);break;case "B":l&&(d=-1);break;case "G":l&&(d=2,k=-4);break;case "2":h=g=0}res.sheets.duck.Draw(a,"shadow",0,this.x,this.y);res.sheets.duck.Draw(a,"arm_back","G"==this.expression?5:"E"==this.expression?4:"B"==this.expression?3:c?2:"4"==this.expression?1:0,this.x+0,this.y+f);res.sheets.duck.Draw(a,"feet",c?2:0,this.x,this.y);"2"!=this.expression&&res.sheets.duck.Draw(a,"hair",c?1:0,this.x+d+g,this.y+k+h);res.sheets.duck.Draw(a,"body",c?2:0,this.x+0,this.y+e);"6"!=this.expression&&
res.sheets.duck.Draw(a,"arm_front","G"==this.expression?5:"C"==this.expression?4:"B"==this.expression?3:c?2:0,this.x+0,this.y+f);res.sheets.duck.Draw(a,"head",m,this.x+g,this.y+h)}if(this.state==STATE_DRAW&&.3<=this.animationTime){f=(this.animationTime-.3)/.3;1<f&&(f=1);f*=120;g=this.y+140+150-f;a.save();a.translate(this.x+142,g);if(.65<=this.animationTime&&.75>=this.animationTime||.8<=this.animationTime&&.85>=this.animationTime)a.scale(-1,1),a.translate(-114,0);a.drawImage(res.sprites.scribble,114*
(250>b%500?2:3),0,114,120,0,0,114,f);a.restore()}if(this.stakeShown){g=battle.defaultBounds.x1;f=battle.defaultBounds.y1-25-25;h=battle.defaultBounds.y1-25-f;this.state==STATE_HANGING&&(h=-f+(f+25)*this.animationTime);a.save();a.translate(g,h);1==this.stakeShield&&((this.state==STATE_SHIELDING||this.state==STATE_UNSHIELDING)&&.9>this.animationTime?.5>this.animationTime?(g=battle.defaultBounds.x1-25,h=this.state==STATE_SHIELDING?h+20-h*Utils.Clamp((this.animationTime-.3)/.07,0,1):h+20):(g=battle.defaultBounds.x1-
(battle.defaultBounds.x1-this.x)*(this.animationTime-.5)/.4,h=this.y):this.state==STATE_HURT||this.state==STATE_BREAK?(g=this.x,h=this.y):(g=this.x+0,h=this.y+e),a.translate(g-50,h+100),a.translate(-125,-f/2));if(this.state!=STATE_BREAK)a.save(),e=0,this.state==STATE_HURT&&1==this.stakeShield&&(e=10*Math.sin(b/20)),a.translate(e,0),this.DrawQV(a,b,f),1==this.stakeShield&&(this.state!=STATE_UNSHIELDING||.3<=this.animationTime)&&(res.sheets.duck.Draw(a,"arm_more",1,-25,0),res.sheets.duck.Draw(a,"arm_more",
2,-25,0)),a.restore();else{e=0;.3>this.animationTime&&(e=Math.sin(b/20)*(11+10*this.animationTime/.3));a.translate(e,0);e=0;.3<=this.animationTime&&(e=(this.animationTime-.3)/.5,e=Utils.Clamp(e,0,1));.8<=this.animationTime&&(this.stakeShield=2,this.stakeShown=!1);g=Utils.CurvePos({x:0,y:0},{x:-125,y:a.canvas.height+100},200,e);e=Utils.CurvePos({x:0,y:0},{x:125,y:a.canvas.height+100},300,e);a.strokeStyle="#000";a.lineWidth=6;a.save();a.beginPath();a.translate(g.x,g.y);a.moveTo(0,0);a.lineTo(125,0);
for(g=0;10>g;g++)h=30*g,a.lineTo(105,h+10),a.lineTo(145,h+20);a.lineTo(0,f);a.stroke();a.clip();a.closePath();this.DrawQV(a,b,f);a.restore();a.save();a.beginPath();a.translate(e.x,e.y);a.moveTo(250,0);a.lineTo(125,0);for(e=0;10>e;e++)g=30*e,a.lineTo(105,g+10),a.lineTo(145,g+20);a.lineTo(250,f);a.stroke();a.clip();a.closePath();this.DrawQV(a,b,f);a.restore();.3>this.animationTime&&(res.sheets.duck.Draw(a,"arm_more",1,-25,0),res.sheets.duck.Draw(a,"arm_more",2,-25,0))}a.restore()}}DrawQV(a,b,c){a.lineWidth=
6;a.strokeStyle="#000";a.fillStyle="#fff";a.save();a.beginPath();Utils.RoundedRect(a,0,0,250,c,6);a.fill();a.clip();a.fillStyle="#edeef0";a.fillRect(0,0,250,45);a.font="24px Pangolin";a.fillStyle="#000";a.textAlign="center";a.textBaseline="top";let d=loc.Get("hud","qv"),e=a.measureText(d).width;a.drawImage(res.sprites.ducky,(250-e)/2-12-6,10);a.fillText(d,141,12);2==this.enemy.signed?res.sheets.promo2.Draw(a,"promo2",Utils.GetAnimationFrame(b,200,res.sheets.promo2.GetTagFrames("idle")),0,45):res.sheets.promo1.Draw(a,
"promo1",Utils.GetAnimationFrame(b,200,res.sheets.promo1.GetTagFrames("idle")),0,45);a.fillStyle="#edeef0";a.fillRect(0,c-80,250,80);if(0<this.enemy.resetCounter||2<=this.enemy.signed)a.fillStyle="#000",a.font="36px Pangolin",d=2==this.enemy.signed?"1":3==this.enemy.signed?"2":"324905",e=a.measureText(d).width,a.textBaseline="bottom",a.drawImage(res.sprites.minipencil,e/2+130-12,c-70),a.fillText(d,109,c-35),a.textAlign="left",a.font="24px Pangolin",d=loc.Get("hud","before_reset"),e=a.measureText(d).width+
40,a.fillText(d,40,c-10),d=2<=this.enemy.signed?` 2 ${loc.Get("hud","h")}`:` ${this.enemy.resetCounter} ${loc.Get("hud","m")}`,a.fillStyle=TEXT_COLORS[2],a.fillText(d,e,c-10),e+=a.measureText(d).width;a.stroke();a.closePath();a.restore();2>this.enemy.signed&&a.drawImage(this.vandalismCanvas,-55,-25);a.font="24px Pangolin";a.textAlign="left";a.textBaseline="bottom";a.fillStyle=TEXT_COLORS[2];for(let f in this.deltas)b=(this.deltaTime-this.deltas[f].timer-this.deltaStickTime)/(this.deltaTime-this.deltaStickTime),
b=Utils.Clamp(b,0,1),a.globalAlpha=1-b,a.fillText(`-${this.deltas[f].delta}`,e+5,c-10-25*b),a.globalAlpha=1;0==this.enemy.resetCounter&&2>this.enemy.signed&&(a.fillStyle="#000",a.beginPath(),Utils.RoundedRect(a,0,c-80,250,80,6),a.fill(),a.closePath(),a.fillStyle="#fff",a.font="46px Pangolin",a.textAlign="center",a.textBaseline="middle",a.fillText(loc.Get("hud","free"),125,c-35))}}
class PromoDuck extends Enemy{constructor(){super();this.code="duck";this.name=loc.Get("enemies","duck");this.index={x:0,y:0};this.maxHP=500;this.attacks=[CardAttack,ThrowAttack,MouthAttack,BallAttack,HandsAttack];this.actions=[{name:loc.Get("actions","check"),index:{x:0,y:0},action:this.Check.bind(this)},{name:loc.Get("actions","bet"),index:{x:1,y:0},action:this.Bet.bind(this)},{name:loc.Get("actions","vandalism"),index:{x:0,y:1},action:this.Vandalize.bind(this)}];this.normalActions=[...this.actions];
this.shieldedActions=[this.actions[0],this.actions[1]];this.shieldDealActions=[this.actions[0],{name:loc.Get("actions","wait"),index:{x:1,y:1},action:this.Wait.bind(this),highlighted:!0},this.actions[2]];this.endingActions=[this.actions[0],{name:loc.Get("actions","credits"),index:{x:2,y:0},action:this.Credits.bind(this),highlighted:!0}];this.noActions=[this.actions[0]];this.killedActions=[{name:loc.Get("actions","credits"),index:{x:2,y:0},action:this.Credits.bind(this),highlighted:!0}];this.flavourText=
this.Dial("idle");this.dangerFlavourText=this.Dial("idle2")}CreateSprite(a,b){return this.sprite=new PromoDuckSprite(a,b,this)}Start(){super.Start();this.resetCounter=45;this.signed=this.dealDunno=this.dealBroke=this.dealNo=this.dealt=this.resetTalk=0;this.dumbBaby=!1;this.failedAttack=this.mockery=this.actualHurt=this.hurt=this.bet=this.check=this.story=0;this.mockAnnoyed=!1;this.weakened=this.popsicleHP=this.popsicle=this.drawAttempt=0;this.justWeakened=!1;this.dontEvenThink=this.wtf=this.drawn=
this.shieldDeal=this.shielding=this.call=0}GetAttack(){if(0>=this.resetCounter&&1==this.signed)return{attackClass:ByeAttack,difficulty:1};if(4<=this.weakened||1==this.shieldDeal)return{attackClass:TrueNothingAttack,difficulty:1};if(2<=this.signed)return{attackClass:NothingAttack,difficulty:1};if(2==this.drawAttempt)return{attackClass:ScribbleAttack,difficulty:1};if(0>=this.resetCounter&&0==this.signed)return{attackClass:NothingAttack,difficulty:1};if(1==this.popsicle)return{attackClass:PopsicleAttack,
difficulty:1};let a={attackClass:this.attacks[this.attackCounter%this.attacks.length],difficulty:1};this.attackCounter>=this.attacks.length&&(a.difficulty=2);this.attackCounter>=2*this.attacks.length&&(a.attackClass=Utils.RandomArray(this.attacks));this.attackCounter++;return a}Idle(){return 3==this.signed?{text:this.Dial("idle_signed_alt")}:2==this.signed?{text:this.Dial("idle_signed")}:4<=this.weakened?{text:this.Dial("idle_geno3")}:0>=this.resetCounter?{text:this.Dial("idle_free")}:1==this.shieldDeal?
{text:this.Dial("idle_shield_deal")}:2==this.weakened?{text:this.Dial("idle_weakened")}:2==this.failedAttack?{text:this.Dial("idle_tutorial")}:1==this.call?{text:this.Dial("idle_geno")}:3==this.call?{text:this.Dial("idle_geno2")}:0==this.weakened&&0==this.call?{text:[Utils.RandomArray(this.flavourText)]}:{text:[Utils.RandomArray(this.dangerFlavourText)]}}DealDamage(a){if(0<a)if(a>this.hp&&0==this.shielding)a=this.hp-2;else if(1==this.shielding)a=1;else if(2==this.shielding||-1==this.shielding)2==
this.shielding&&(this.weakened=5),a=this.hp;return super.DealDamage(a)}Hurt(a){this.hurt++;this.justWeakened&&(this.justWeakened=!1);if(1==this.shielding&&0<a)return this.actions=[...this.noActions],this.shieldDeal=2,{speech:this.Dial("geno_break"),actions:[()=>new BreakAction(this)]};if(5==this.weakened||-1==this.shielding)return this.actions=[...this.killedActions],a=["&0"],-1==this.shielding?(this.weakened=5,battle.theme.Swap({r:0,g:0,b:0},{r:170,g:170,b:170},!0),res.sfx.bgm.pause(),res.sfx.bgmGeno.pause(),
a=this.Dial("shield_betrayal"),battle.SetEnding(3)):battle.SetEnding(4),{speech:a,actions:[()=>new DeathAction(this)]};0<a&&this.DecreaseResetCounter(1);if(.6>=this.hp/this.maxHP&&0==this.weakened)return this.weakened=1,this.justWeakened=!0,a={speech:this.Dial("weakened")},0>=this.resetCounter&&(this.resetTalk=1,a.speech=this.Dial("weakened_alt")),res.sfx.bgm.pause(),res.sfx.bgmGeno.play(),this.bet=3,a;if(0<a){this.actualHurt++;if(0==this.weakened&&0==this.call&&2<=this.mockery&&1==this.actualHurt)return{speech:this.Dial("attack_finally")};
if(0==this.drawAttempt&&0==this.weakened&&0==this.call)return this.drawAttempt=1,{speech:this.Dial("attack_scribble"),actions:[()=>new DrawAction(this)]}}else if(0==this.weakened&&0==this.call){this.mockery++;0==this.actualHurt&&(this.failedAttack=1);if(2<=this.actualHurt&&3<=this.mockery){if(this.mockAnnoyed)return{speech:this.StoryFlow()};this.mockAnnoyed=!0;return{speech:this.Dial("annoyed")}}switch(this.mockery){case 1:return{speech:this.Dial("mockery1")};case 2:return{speech:this.Dial("mockery2")};
case 3:return{speech:this.Dial("mockery3")};case 4:return{speech:this.Dial("mockery4")};case 5:return{speech:this.Dial("mockery5")}}}return{speech:this.StoryFlow()}}Deal(a,b,c,d){this.dealt++;let e=this.Dial("deal_pre");if(a&&b||30<c&&.7<d/c){this.dealBroke++;switch(this.dealBroke){case 1:a=this.Dial("deal_broke_1");break;case 2:a=this.Dial("deal_broke_2");break;default:a=this.Dial("deal_broke_3")}e=e.concat(a)}else if(a||b)if(b){this.dealNo++;switch(this.dealNo){case 1:a=this.Dial("deal_no_1");break;
case 2:a=this.Dial("deal_no_2");break;default:a=this.Dial("deal_no_3")}e=e.concat(a)}else a&&(e=e.concat(this.Dial("deal_signed")),this.signed=1);else{this.dealDunno++;switch(this.dealDunno){case 1:a=this.Dial("deal_dunno_1");break;case 2:a=this.Dial("deal_dunno_2");break;default:a=this.Dial("deal_dunno_3")}e=e.concat(a)}3<=this.dealNo+this.dealBroke+this.dealDunno&&!this.dumbBaby&&(this.dumbBaby=!0);return{speech:e}}Drawn(a){this.drawn++;let b={text:this.Dial("vandalism_fail")},c=0;100<=a?(c=5,b.text=
this.Dial("vandalism_success_4")):50<=a?(c=3,b.text=this.Dial("vandalism_success_3")):25<=a?(c=2,b.text=this.Dial("vandalism_success_2")):5<=a&&(c=1,b.text=this.Dial("vandalism_success_1"));this.DecreaseResetCounter(c);0==c&&(0==this.dontEvenThink&&3>this.wtf?(this.dontEvenThink=1,b.speech=this.Dial("vandalism_fail_speech")):b.speech=this.StoryFlow());0<c&&(this.wtf++,a=this.StoryFlow(),b.speech=a);return b}StoryFlow(){if(0<this.signed||4<=this.weakened)return null;if(0>=this.resetCounter)switch(this.resetTalk++,
1==this.resetTalk&&0<this.dealt&&(this.resetTalk=2),this.resetTalk){case 1:return this.Dial("reset_1");case 2:return this.Dial("reset_2");case 3:return this.Dial("reset_3");case 4:return this.Dial("reset_4");case 10:return this.Dial("reset_6");default:return this.Dial("reset_5")}if(1>this.wtf||0!=this.shielding)return null;this.story++;switch(this.story){case 1:return this.Dial("story_1");case 2:return this.Dial("story_2");case 3:return this.Dial("story_3");case 4:return this.Dial("story_4");case 5:return this.Dial("story_5");
case 6:return this.Dial("story_6");case 7:return this.Dial("story_7");case 8:if(0<this.weakened)return this.Dial("story_8_alt")}return 0==this.popsicle&&0==this.weakened&&0==this.call?(this.popsicle=1,this.popsicleHP=battle.hp,this.Dial("story_8")):null}DecreaseResetCounter(a){2<=this.shielding||(this.resetCounter-=a,0>=this.resetCounter&&(a+=this.resetCounter,this.resetCounter=0,this.signed||(this.actions=[...this.normalActions],1==this.shielding&&(this.actions=[this.actions[0],this.actions[1]]),
0==this.dealt&&null!=this.actions[1]&&(this.actions[1].highlighted=!0))),0<a&&this.sprite.AddDelta(a))}AttackEnd(){this.DecreaseResetCounter(1);1==this.failedAttack?this.failedAttack=2:2==this.failedAttack&&(this.failedAttack=0);if(1==this.signed){this.signed=2;this.weakened=0;this.actions=[...this.endingActions];if(0!=this.call)return battle.SetEnding(2),{speech:this.Dial("deal_signed_2_alt"),actions:[()=>new RebetAction(this)]};battle.SetEnding(1);return{speech:this.Dial("deal_signed_2"),actions:[()=>
new RebetAction(this)]}}if(2==this.drawAttempt)return this.drawAttempt=3,{speech:this.Dial("attack_scribble_2")};if(1==this.popsicle)return this.popsicle=2,battle.hp<this.popsicleHP?{speech:this.Dial("attack_popsicle_fail")}:{speech:this.Dial("attack_popsicle_success")};1==this.weakened?this.weakened=2:2==this.weakened&&(this.weakened=3);if(!this.justWeakened){if(.5>=this.hp/this.maxHP&&1>this.call)return this.call=1,{speech:this.Dial("geno_phone")};if(.2>=this.hp/this.maxHP&&3>this.call)return this.call=
3,this.actions=[...this.shieldedActions],0==this.dealt&&null!=this.actions[1]&&(this.actions[1].highlighted=!0),{speech:this.Dial("geno_phone_2"),actions:[()=>new ShieldAction(this)]};1==this.call&&(this.call=2)}return{}}Check(){this.check++;if(4<=this.weakened)return{text:this.Dial("check_geno")};let a={text:this.Dial("check"),speech:this.Dial("check_speech")};1<this.check&&(delete a.speech,a.text=this.Dial("check_2"),a.speech=this.StoryFlow());return a}Wait(){this.shieldDeal=-1;this.actions=[...this.normalActions];
res.sfx.bgmGeno.pause();battle.Blank(!0);return{text:this.Dial("shield_deal_wait"),speech:this.Dial("shield_deal_wait_speech"),actions:[()=>new WaitEndAction(this)]}}Bet(){this.bet++;if(1==this.shielding&&0==this.shieldDeal&&0<this.resetCounter)return this.shieldDeal=1,this.actions=[...this.shieldDealActions],{text:this.Dial("shield_deal"),speech:this.Dial("shield_deal_speech"),actions:[()=>new UnshieldAction(this)]};if(0>=this.resetCounter){if(1==this.shielding)return{text:this.Dial("shield_deal_alt"),
speech:this.Dial(0<this.resetTalk?"shield_deal_alt2_speech":"shield_deal_alt_speech"),mode:DEAL,actions:[()=>new UnshieldAction(this)]};let a={text:this.Dial("bet_draw"),mode:DEAL};this.dumbBaby&&(a.speech=this.Dial("bet_dumb"));return a}switch(this.bet){case 1:return{text:this.Dial("bet_early"),speech:this.Dial("bet_early_speech")};case 2:return{text:this.Dial("bet_early_2"),speech:this.Dial("bet_early_2_speech")};default:return{text:this.Dial("bet_early_3"),speech:this.StoryFlow()}}}Vandalize(){return{text:this.Dial("vandalism"),
mode:DRAW}}Nothing(){return{text:[""],speech:this.StoryFlow()}}Credits(){return{text:this.Dial(3==battle.ending||4==battle.ending?"thanks_for_playing_alt":"thanks_for_playing"),mode:CREDITS}}}class TriggerAction{constructor(a){this.parent=a;this.finished=!1}Start(){}Render(a,b){}GameLoop(a){}PointerUp(a){}Finish(){this.parent=null;this.finished=!0}}
class DrawAction extends TriggerAction{constructor(a){super(a);this.animationTimer=this.animationTime=200}Start(){this.soundPlayed=!1;this.parent.sprite.SetAnimation(STATE_DRAW,0)}GameLoop(a){this.animationTimer-=1*a;a=1-this.animationTimer/this.animationTime;this.parent.sprite.SetAnimation(STATE_DRAW,a);.3<=a&&!this.soundPlayed&&(this.soundPlayed=!0,res.sfx.scribble1.play());0>=this.animationTimer&&this.Finish()}Finish(){this.parent.sprite.SetAnimation(STATE_DRAW,1);this.parent.drawAttempt=2;super.Finish()}}
class StakeAction extends TriggerAction{constructor(a){super(a);this.animationTimer=this.animationTime=50}Start(){this.parent.sprite.stakeShown=!0;this.animationTimer=this.animationTime;this.parent.sprite.SetAnimation(STATE_HANGING,0)}GameLoop(a){this.animationTimer-=1*a;this.parent.sprite.SetAnimation(STATE_HANGING,1-this.animationTimer/this.animationTime);0>=this.animationTimer&&this.Finish()}Finish(){this.parent.sprite.SetAnimation(STATE_NORMAL,0);super.Finish()}}
class ShieldAction extends TriggerAction{constructor(a){super(a);this.animationTimer=this.animationTime=400}Start(){this.parent.sprite.stakeShown=!0;this.animationTimer=this.animationTime;this.parent.sprite.SetAnimation(STATE_SHIELDING,0)}GameLoop(a){this.animationTimer-=1*a;this.parent.sprite.SetAnimation(STATE_SHIELDING,1-this.animationTimer/this.animationTime);0>=this.animationTimer&&this.Finish()}Finish(){this.parent.sprite.SetAnimation(STATE_NORMAL,0);this.parent.shielding=1;super.Finish()}}
class UnshieldAction extends TriggerAction{constructor(a){super(a);this.animationTimer=this.animationTime=200}Start(){this.parent.sprite.stakeShown=!0;this.animationTimer=this.animationTime;this.parent.sprite.SetAnimation(STATE_UNSHIELDING,1)}GameLoop(a){this.animationTimer-=1*a;this.parent.sprite.SetAnimation(STATE_UNSHIELDING,this.animationTimer/this.animationTime);0>=this.animationTimer&&this.Finish()}Finish(){this.parent.sprite.SetAnimation(STATE_NORMAL,0);this.parent.shielding=-1;this.parent.sprite.stakeShield=
0;super.Finish()}}
class BreakAction extends TriggerAction{constructor(a){super(a);this.animationTimer=this.animationTime=100;this.broke=!1}Start(){this.animationTimer=this.animationTime;this.parent.sprite.SetAnimation(STATE_BREAK,0)}GameLoop(a){this.animationTimer-=1*a;a=1-this.animationTimer/this.animationTime;this.parent.sprite.SetAnimation(STATE_BREAK,a);.3<=a&&!this.broke&&(this.broke=!0,battle.theme.Swap({r:0,g:0,b:0},{r:170,g:170,b:170},!0),this.parent.weakened=4,res.sfx.explosion.play(),res.sfx.bgm.pause(),res.sfx.bgmGeno.pause());
0>=this.animationTimer&&this.Finish()}Finish(){this.parent.sprite.SetAnimation(STATE_NORMAL,0);this.parent.shielding=2;super.Finish()}}
class DeathAction extends TriggerAction{constructor(a){super(a);this.animationTimer=this.animationTime=200}Start(){this.animationTimer=this.animationTime;this.parent.sprite.SetAnimation(STATE_DEAD,0)}GameLoop(a){this.animationTimer-=1*a;this.parent.sprite.SetAnimation(STATE_DEAD,1-this.animationTimer/this.animationTime);0>=this.animationTimer&&this.Finish()}Finish(){super.Finish()}}
class WaitEndAction extends TriggerAction{constructor(a){super(a)}Start(){this.Finish()}Finish(){this.parent.DecreaseResetCounter(this.parent.resetCounter);this.parent.weakened=-1;this.parent.shielding=-1;this.parent.resetTalk=1;this.parent.sprite.stakeShield=0;res.sfx.bgm.play();battle.Blank();super.Finish()}}
class RebetAction extends TriggerAction{constructor(a){super(a);this.speechBubble=new SpeechBubble(null,res.sfx.other,!0)}Start(){this.speechBubble.Start();this.speechBubble.textBounds.x1=1030;this.speechBubble.textBounds.x2=1230;this.speechBubble.textBounds.y1=battle.defaultBounds.y1-200;this.speechBubble.SetText(loc.Dial("duck","deal_signed_2_other"))}GameLoop(a){this.speechBubble.GameLoop(a);this.speechBubble.finished&&this.Finish()}PointerUp(a){this.speechBubble.PointerUp(a)}Render(a,b){this.speechBubble.Render(a,
b)}Finish(){this.parent.signed=3;super.Finish()}};class Attack{constructor(a,b,c,d){this.caster=a;this.difficulty=b;this.timeOut=!1;this.tickCount=0;this.projectileTime=c;this.attackTime=d;this.endTime=this.startTime=20;this.x=this.caster.x+this.caster.pivot.x;this.y=this.caster.y+this.caster.pivot.y;this.spawnedProjectiles=[];this.startBounds={x1:515,y1:300,x2:765,y2:550,a:1}}Start(){this.timeOut=!1;this.projectileTimer=this.tickCount=0;this.attackTimer=this.attackTime;this.startTimer=this.startTime;this.endTimer=this.endTime;battle.SetBounds(this.startBounds)}End(){battle.OnAttackEnd()}Render(a,
b){}GameLoop(a){if(battle.boundsReady){if(0<this.startTimer&&(this.startTimer-=1*a,0<this.startTimer))return;this.attackTimer-=1*a;0>=this.attackTimer?(this.timeOut||this.OnTimeOut(),this.OnGameLoop(a),0==this.spawnedProjectiles.length&&(this.endTimer-=1*a,0>=this.endTimer&&this.End())):(this.projectileTimer-=1*a,0>=this.projectileTimer&&(this.tickCount++,this.SpawnProjectile(this.tickCount),this.projectileTimer=this.NextProjectileTime(this.tickCount)),this.OnGameLoop(a))}}NextProjectileTime(a){return this.projectileTime}OnTimeOut(){this.timeOut=
!0}Finish(){this.attackTimer=0}OnGameLoop(a){}SpawnProjectile(a){}}
class Projectile extends Entity{constructor(a,b,c,d,e,f,g){super(c,d,e,f);this.onTop=!1;this.parent=a;this.index=b;this.damage=g;this.speed=5;this.lifeTimer=this.honingTimer=this.honingTime=0;this.destructible=!0;this.toDestroy=!1}Start(){this.honingTimer=this.honingTime;this.lifeTimer=0}Collision(a){if(0<this.honingTimer)return!1;let b=Utils.RotatePoint({x:battle.soul.x+battle.soul.pivot.x,y:battle.soul.y+battle.soul.pivot.y},{x:this.x+this.pivot.x,y:this.y+this.pivot.y},-this.rotation);return Utils.Distance({x:Math.max(this.x,
Math.min(b.x,this.x+this.w)),y:Math.max(this.y,Math.min(b.y,this.y+this.h))},b)<(a?battle.soul.grazeRadius:battle.soul.radius)?!0:!1}Draw(a,b){a.fillStyle="red";a.fillRect(-this.pivot.x,-this.pivot.y,this.w,this.h)}GameLoop(a){0<this.honingTimer&&(this.honingTimer-=1*a);this.lifeTimer+=1*a}}
class TestAttack extends Attack{constructor(a,b){super(a,b,30,200)}SpawnProjectile(a){a=new TestProjectile(this,a,battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2);battle.AddProjectile(this,a)}}class TestProjectile extends Projectile{constructor(a,b,c,d){super(a,b,c,d,100,100,10)}}
class CardAttack extends Attack{constructor(a,b){super(a,b,400,400)}Start(){super.Start();let a=16;2==this.difficulty&&(a=12);let b=80;for(let c=0;c<a;c++){let d=new CardProjectile(this,c,this.x,this.y);d.count=a;d.appearTime=50;b=2==this.difficulty?b+Utils.ReverseQuadratic(25,40,c,a):b+Utils.ReverseQuadratic(15,30,c,a);d.honingTime=b;d.speed=Utils.Quadratic(7,10,c,a);battle.AddProjectile(this,d)}}OnGameLoop(a){super.OnGameLoop(a)}}
class CardProjectile extends Projectile{constructor(a,b,c,d){super(a,b,c,d,50,75,2);this.pivot.x=this.w/2;this.x-=this.pivot.x;this.originalPos={x:c,y:d};this.bounceCount=0;this.count;this.appearTime;this.preThrowTime=15;this.speed=7;this.vy=1}Draw(a,b){a.save();a.rotate(Math.PI/2);a.drawImage(res.sprites.card,2==this.parent.difficulty?90:0,0,90,60,-this.pivot.y-7.5,-this.pivot.x-5,this.h+15,this.w+10);a.restore()}GameLoop(a){super.GameLoop(a);if(0<this.honingTimer){var b=.8*Math.cos((this.honingTime-
this.honingTimer)/25-this.index/this.count)-.1;a=b*(100+50*(this.honingTime-this.honingTimer)/this.honingTime);this.rotation=-b/5;this.honingTimer>=this.honingTime-this.appearTime?(b=1-(this.honingTimer-(this.honingTime-this.appearTime))/this.appearTime,this.x=this.originalPos.x+b*a,this.y=this.originalPos.y-6*b*this.index):this.honingTimer>this.preThrowTime?this.x=this.originalPos.x+a:(this.onTop=!0,this.y=this.originalPos.y-6*this.index-(this.preThrowTime-this.honingTimer)/this.preThrowTime*32)}else b=
this.speed*a,b=0<this.speed?b*this.vy:b+a*this.vy/2,this.rotation+=Math.PI/60*a*Math.abs(b)/15,this.y+=b,2==this.parent.difficulty&&(this.vy*=1.03,this.y>battle.bounds.y2&&1>this.bounceCount&&(this.y=battle.bounds.y2,this.speed=-Math.min(8,Math.abs(this.speed)),this.bounceCount++,this.vy=3))}}
class ThrowAttack extends Attack{constructor(a,b){super(a,b,35,300);2==this.difficulty&&(this.projectileTime=25)}SpawnProjectile(a){var b=battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2,c=battle.bounds.y1+(battle.bounds.y2-battle.bounds.y1)/2;let d=Utils.Random(0,2*Math.PI);a=new ThrowProjectile(this,a,b+250*Math.cos(d),c+250*Math.sin(d));battle.AddProjectile(this,a)}NextProjectileTime(a){return 0==a%3?1.5*this.projectileTime:2==this.difficulty?10:super.NextProjectileTime(a)}}
class ThrowProjectile extends Projectile{constructor(a,b,c,d){super(a,b,c,d,25,80,3);this.speed=1==b%3?15:30;this.honingTime=50;this.pivot.y=0;this.angle=Math.atan2(battle.soul.y-this.y-this.pivot.y,battle.soul.x-this.x-this.pivot.x);this.rotation=this.angle-Math.PI/2;this.origin={x:this.x,y:this.y};this.targetPos={x:75*-Math.cos(this.angle),y:75*-Math.sin(this.angle)}}GameLoop(a){super.GameLoop(a);0<this.honingTimer?(this.onTop=!0,this.x=this.origin.x+Utils.ReverseQuadratic(0,this.targetPos.x,this.honingTimer,
this.honingTime),this.y=this.origin.y+Utils.ReverseQuadratic(0,this.targetPos.y,this.honingTimer,this.honingTime)):(this.onTop=!1,this.x+=Math.cos(this.angle)*this.speed*a,this.y+=Math.sin(this.angle)*this.speed*a)}Draw(a,b){0<this.honingTimer&&(a.globalAlpha=(this.honingTime-this.honingTimer)/this.honingTime);a.drawImage(res.sprites.pencils,this.index%3*40,0,40,120,-20,-this.pivot.y-12,40,120);a.globalAlpha=1}}
class ScribbleAttack extends Attack{constructor(a,b){super(a,b,15,15)}Start(){super.Start();this.scribble=new ScribbleProjectile(this,0,this.caster.x+142+20,this.caster.y+140+40,this.startBounds.x2+25,this.startBounds.y2-90);battle.AddProjectile(this,this.scribble)}}
class ScribbleProjectile extends Projectile{constructor(a,b,c,d,e,f){super(a,b,c,d,75,75,1);this.startPos={x:c,y:d};this.targetPos={x:e,y:f};this.honingTime=30;this.destroyTime=15;this.hop=0}Start(){super.Start();this.destroyTimer=this.destroyTime;this.destroyLaunch=!1;res.sfx.scribble2.play()}GameLoop(a){super.GameLoop(a);0<this.honingTimer?(a=Utils.CurvePos(this.startPos,this.targetPos,200,(this.honingTime-this.honingTimer)/this.honingTime),this.x=a.x,this.y=a.y):(1>this.lifeTimer%25&&((0==this.hop%
2?res.sfx.hop2:res.sfx.hop).play(),this.hop++),this.y=this.targetPos.y,this.x-=1*a,this.x<=battle.bounds.x1-this.w&&(this.destroyLaunch=!0),this.destroyLaunch&&(this.destroyTimer-=1*a,0>=this.destroyTimer&&(this.toDestroy=!0)))}Draw(a,b){this.destroyLaunch&&(a.globalAlpha=this.destroyTimer/this.destroyTime);a.drawImage(res.sprites.scribble,0<this.honingTimer?456:12>this.lifeTimer%25?0:114,0,114,120,-this.pivot.x-20,-this.pivot.y-10,114,120);a.globalAlpha=1}}
class MouthAttack extends Attack{constructor(a,b){super(a,b,50,300);2==this.difficulty&&(this.projectileTime=20)}SpawnProjectile(a){a=new MouthProjectile(this,a,battle.soul.x-32,battle.soul.y-32);battle.AddProjectile(this,a)}NextProjectileTime(){return this.projectileTime}}
class MouthProjectile extends Projectile{constructor(a,b,c,d){super(a,b,c,d,64,64,5);this.appearTime=20;this.honingTime=50;this.lifeTime=100}GameLoop(a){super.GameLoop(a);this.lifeTimer>this.lifeTime&&(this.toDestroy=!0)}Draw(a,b){0<=this.honingTimer?a.globalAlpha=(this.honingTime-this.honingTimer)/this.appearTime:this.lifeTimer>this.lifeTime-this.appearTime&&(a.globalAlpha=(this.lifeTime-this.lifeTimer)/this.appearTime);b=(this.honingTime-this.honingTimer)/this.honingTime;a.drawImage(res.sprites.eat,
0,112,108,47,-70,16,108,47);a.drawImage(res.sprites.eat,0,0,108,86,-70,-64-50*(1-b),108,86);a.globalAlpha=1}Collision(a){return this.lifeTimer>this.lifeTime-this.appearTime?!1:super.Collision(a)}}
class BallAttack extends Attack{constructor(a,b){super(a,b,5,300);this.startTime=100;this.angle=0;this.tails=5;2==this.difficulty&&(this.tails=6);this.count=this.attackTime/this.projectileTime*this.tails}Start(){super.Start();this.x=this.startBounds.x1+(this.startBounds.x2-this.startBounds.x1)/2;this.y=this.startBounds.y1+(this.startBounds.y2-this.startBounds.y1)/2}OnGameLoop(a){a=this.tickCount+(this.projectileTime-this.projectileTimer)/this.projectileTime;this.angle=2==this.difficulty?Math.PI/Utils.ReverseQuadratic(18,
30,a*this.tails,this.count)*a:Math.PI/Utils.ReverseQuadratic(22,36,a*this.tails,this.count)*a}SpawnProjectile(a){for(let b=0;b<this.tails;b++){let c=new BallProjectile(this,a*this.tails+b,this.x-5,this.y-5,this.angle+b*Math.PI/this.tails*2);battle.AddProjectile(this,c)}}Render(a,b){super.Render(a,b);a.save();a.translate(this.x,this.y-this.y/2*this.startTimer/this.startTime);a.rotate(this.angle-Math.PI/7);a.drawImage(res.sprites.star,-23,-24);a.restore()}}
class BallProjectile extends Projectile{constructor(a,b,c,d,e){super(a,b,c,d,10,10,2);this.angle=e;this.speed=4;this.lifeTime=50;this.appearTime=20;this.sprite=Utils.RandomRound(0,5)}GameLoop(a){super.GameLoop(a);this.x+=Math.cos(this.angle)*this.speed*a;this.y+=Math.sin(this.angle)*this.speed*a;this.lifeTimer>this.lifeTime&&(this.toDestroy=!0)}Draw(a,b){this.lifeTimer>this.lifeTime-this.appearTime&&(a.globalAlpha=(this.lifeTime-this.lifeTimer)/this.appearTime);a.drawImage(res.sprites.chunks,16*this.sprite,
0,16,18,-8,-9,16,18);a.globalAlpha=1}}
class PopsicleAttack extends Attack{constructor(a,b){super(a,b,1E3,1E3);this.formTime=this.stickWait=this.stickTime=25;this.formWait=50;this.crackWait=40;this.tipTime=200;this.tipTimer=0;this.velocityThreshold=7;this.attackAnimations={bare:res.sheets.popsicle.GetTagFrames("bare"),form:res.sheets.popsicle.GetTagFrames("form"),break:res.sheets.popsicle.GetTagFrames("break"),wet:res.sheets.popsicle.GetTagFrames("wet"),parts:res.sheets.popsicle.GetTagFrames("parts")};this.wallDistance=3;this.breaksPerFrame=
8;this.breaksToCrack=this.breaksPerFrame*this.attackAnimations.break.length}Start(){super.Start();this.break=0;this.boundsSet=this.broken=!1;this.tipTimer=this.tipTime;this.wasTouchingY=this.wasTouchingX=!1;let a={x1:578,y1:352,x2:702,y2:550,a:1};battle.SetBounds(a);battle.SetFakeBounds({x1:(a.x2-a.x1)/2,y1:(a.y2-a.y1)/2,x2:-(a.x2-a.x1)/2+battle.soul.radius,y2:-(a.y2-a.y1)/2-55});this.startPos={x:a.x1+(a.x2-a.x1)/2,y:a.y2}}OnGameLoop(a){super.OnGameLoop(a);this.boundsSet&&0<this.tipTimer&&(this.tipTimer-=
1*a);this.attackTime-this.attackTimer>=this.stickTime+this.formTime+this.formWait&&!this.boundsSet&&(this.boundsSet=!0,battle.SetBounds(this.startBounds),battle.SetFakeBounds({x1:52,y1:24,x2:-52,y2:-158}),battle.soul.locked=!1,battle.soul.SetSlowed(!0));if(this.boundsSet){if(!this.broken){let c=battle.SoulBounds(),d=!1,e=!1;var b=a=0;c.x1<=battle.fakeBounds.x1+this.wallDistance?(a=-1,d=!0):c.x2>=battle.fakeBounds.x2-this.wallDistance&&(a=1,d=!0);c.y1<=battle.fakeBounds.y1+this.wallDistance?(b=-1,
e=!0):c.y2>=battle.fakeBounds.y2-this.wallDistance&&(b=1,e=!0);d&&this.wasTouchingX&&(a=0);e&&this.wasTouchingY&&(b=0);a*=5;b*=5;(d&&!this.wasTouchingX||e&&!this.wasTouchingY)&&Math.sqrt(battle.soul.velocity.x*battle.soul.velocity.x+battle.soul.velocity.y*battle.soul.velocity.y)>=this.velocityThreshold&&(this.break++,0==this.break%this.breaksPerFrame?res.sfx.crack.play():res.sfx.tick.play(),battle.SetBounds({x1:battle.bounds.x1+a,y1:battle.bounds.y1+b,x2:battle.bounds.x2+a,y2:battle.bounds.y2+b},
!1,!0),battle.fakeBounds={x1:battle.fakeBounds.x1+a,y1:battle.fakeBounds.y1+b,x2:battle.fakeBounds.x2+a,y2:battle.fakeBounds.y2+b});this.wasTouchingX=d;this.wasTouchingY=e}this.break>=this.breaksToCrack&&!this.broken&&(this.broken=!0,res.sfx.break.play(),battle.soul.SetSlowed(!1),this.crackTime=this.attackTime-this.attackTimer,this.crackPos={x:battle.soul.x+battle.soul.radius,y:battle.soul.y-30},battle.ResetFakeBounds());this.broken&&this.attackTime-this.attackTimer-this.crackTime>=this.crackWait&&
this.Finish()}}Render(a,b){var c=battle.soul.x+battle.soul.radius,d=battle.soul.y-30;if(this.attackTime-this.attackTimer<=this.stickTime+this.stickWait)b=(this.attackTime-this.attackTimer)/this.stickTime,b=Utils.Clamp(b,0,1),a.globalAlpha=b,res.sheets.popsicle.Draw(a,"popsicle",this.attackAnimations.bare[0],this.startPos.x,this.startPos.y-(this.startPos.y-d)*b,-1,-1,!0,!1),a.globalAlpha=1;else if(this.attackTime-this.attackTimer<=this.stickTime+this.stickWait+this.formTime)res.sheets.popsicle.Draw(a,
"popsicle",this.attackAnimations.form[Math.round((this.attackAnimations.form.length-1)*(this.attackTime-this.attackTimer-this.stickTime-this.stickWait)/this.formTime)],c,d,-1,-1,!0,!1);else if(this.broken){d=(this.attackTime-this.attackTimer-this.crackTime)/this.crackWait;c=Utils.CurvePos({x:this.crackPos.x,y:this.crackPos.y},{x:this.crackPos.x,y:a.canvas.height},200,d);res.sheets.popsicle.Draw(a,"popsicle",this.attackAnimations.wet[0],c.x,c.y,-1,-1,!0,!1,Math.PI/180*b/10);for(var e in this.attackAnimations.parts)c=
Utils.CurvePos({x:this.crackPos.x-162,y:this.crackPos.y},{x:this.crackPos.x-162+(-50+100/this.attackAnimations.parts.length*e),y:a.canvas.height},300-10*e,d),res.sheets.popsicle.Draw(a,"popsicle",this.attackAnimations.parts[e],c.x,c.y,-1,-1,!1,!1,Math.PI/180*b/30*e)}else res.sheets.popsicle.Draw(a,"popsicle",this.attackAnimations.break[~~(this.break/this.breaksPerFrame)],c,d,-1,-1,!0,!1);if(0>=this.tipTimer&&this.break<this.breaksPerFrame||150>this.attackTimer&&!this.broken)a.font="36px Pangolin",
a.font="Pangolin",a.fillStyle="#666",a.textAlign="center",a.textBaseline="top",b=2*(Math.random()-.5),e=2*(Math.random()-.5),a.fillText(loc.Get("hud",150>this.attackTimer?"hurry_up":"shake"),battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2+b,battle.bounds.y1+15+4+e)}End(){this.broken||battle.Hurt(7);battle.soul.locked=!1;battle.soul.SetSlowed(!1);super.End()}}
class HandsAttack extends Attack{constructor(a,b){super(a,b,150,400);2==this.difficulty&&(this.projectileTime=100)}SpawnProjectile(a){a=new HandsProjectile(this,a,a%2+1);battle.AddProjectile(this,a)}}
class HandsProjectile extends Projectile{constructor(a,b,c){super(a,b,0,0,0,0,4);this.honingTime=50;this.startTime=25;this.startTimer=0;this.lifeTime=150;this.endTime=25;this.side=c;this.destructible=!1}Start(){super.Start();this.startTimer=this.startTime;this.targetPos={};this.startPos={};this.targetPos.y=battle.bounds.y1;this.y=this.startPos.y=this.targetPos.y;this.w=(battle.bounds.x2-battle.bounds.x1)/2-5;this.h=battle.bounds.y2-battle.bounds.y1;switch(this.side){case 1:this.targetPos.x=battle.bounds.x1;
this.x=this.startPos.x=this.targetPos.x-this.w;break;case 2:this.targetPos.x=battle.bounds.x2-this.w,this.x=this.startPos.x=this.targetPos.x+this.w}}GameLoop(a){super.GameLoop(a);0<this.honingTimer?1>this.honingTimer%3&&res.sfx.warning.play():0<this.startTimer?(this.startTimer-=1*a,a=(this.startTime-this.startTimer)/this.startTime,this.x+=(this.targetPos.x-this.x)*a,this.y+=(this.targetPos.y-this.y)*a):this.lifeTimer>=this.lifeTime-this.endTime?(a=(this.lifeTime-this.lifeTimer)/this.endTime,this.x=
this.targetPos.x-(this.targetPos.x-this.startPos.x)*(1-a),this.y=this.targetPos.y-(this.targetPos.y-this.startPos.y)*(1-a),0>=a&&(this.toDestroy=!0)):(this.x=this.targetPos.x,this.y=this.targetPos.y)}Draw(a,b){if(0<this.honingTimer)a.font="48px Pangolin",a.font="Pangolin",a.textAlign="center",a.textBaseline="middle",a.fillStyle=a.strokeStyle=5>this.honingTimer%10?"#ff6a00":"#ff0000",a.lineWidth=6,a.strokeRect(this.targetPos.x-this.x,this.targetPos.y-this.y,this.w,this.h),a.fillText("!",this.targetPos.x-
this.x+this.w/2,this.targetPos.y-this.y+this.h/2);else{a.save();a.beginPath();Utils.RoundedRect(a,battle.bounds.x1-this.x+1,battle.bounds.y1-this.y+1,battle.bounds.x2-battle.bounds.x1-2,battle.bounds.y2-battle.bounds.y1-2,6);a.clip();for(b=0;5>b;b++){let c=this.lifeTimer;res.sheets.hands.Draw(a,1==this.side?"left":"right",b,(1==this.side?-95:this.w-125)+(1==this.side?-1:1)*Math.abs(Math.cos(c/3+2*b))*10,this.h/2+45*(b-2)+5*Math.sin(c/3+b),-1,-1,!1,!0,0,!0)}a.closePath();a.restore()}}}
class NothingAttack extends Attack{constructor(a,b){super(a,b,50,50)}Render(a,b){a.font="36px Pangolin";a.font="Pangolin";a.fillStyle="#666";a.textAlign="center";a.textBaseline="top";b=2*(Math.random()-.5);var c=2*(Math.random()-.5);let d;d=2==this.caster.enemy.signed?loc.Dial("duck","thanks"):0<this.caster.enemy.dealt?loc.Dial("duck","sign_contract"):loc.Dial("duck","make_bet");for(let e in d)a.fillText(d[e],battle.bounds.x1+(battle.bounds.x2-battle.bounds.x1)/2+b,battle.bounds.y1+(battle.bounds.y2-
battle.bounds.y1)/2-36*(d.length-e-1)+4+c)}}
class ByeAttack extends Attack{constructor(a,b){super(a,b,40,240);this.endTime=100;this.startBounds={x1:665,x2:685,y1:270,y2:290}}Start(){super.Start();this.grabbed=!1;this.caster.SetAnimation(STATE_BYE,0);battle.enemiesContainer.SetState(STATE_BYE)}OnGameLoop(a){super.OnGameLoop(a);a=(this.attackTime-this.attackTimer)/(this.attackTime-40);this.caster.SetAnimation(STATE_BYE,a);.1<a&&!this.grabbed&&(this.grabbed=!0,battle.soul.eaten=!0,battle.ResetBounds());0>=battle.hp&&0<this.attackTimer&&(res.sfx.gulp.play(),
this.Finish())}SpawnProjectile(a){1<a&&0<battle.hp&&(Utils.RandomArray([res.sfx.hurt,res.sfx.hurt2]).play(),battle.hp-=4,0>battle.hp&&(battle.hp=0))}}class TrueNothingAttack extends Attack{constructor(a,b){super(a,b,0,0);this.endTime=this.startTime=0}};
